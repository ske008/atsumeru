<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>アツメル</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { font-size: 16px; }
    body { background: #F5F4F1; -webkit-font-smoothing: antialiased; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    input:focus { border-color: #2D5A3D !important; background: #fff !important; }
    button:hover { opacity: 0.88; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const genId = () => Math.random().toString(36).slice(2, 10);
    const fmtDate = (d) => new Date(d).toLocaleDateString("ja-JP", { year: "numeric", month: "long", day: "numeric" });

    const db = {
      get: (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    };

    /* ── デザイントークン ── */
    const C = {
      bg:          "#F5F4F1",
      surface:     "#FFFFFF",
      border:      "#E2E0DB",
      borderDark:  "#C8C6BF",
      text:        "#1C1C1A",
      textSub:     "#6B6B67",
      textMuted:   "#A0A09C",

      primary:     "#2D5A3D",   /* 深緑 */
      primaryBg:   "#EEF4F0",
      primaryText: "#1A3D28",

      danger:      "#B91C1C",
      dangerBg:    "#FEF2F2",

      warn:        "#92400E",
      warnBg:      "#FFFBEB",

      success:     "#166534",
      successBg:   "#F0FDF4",

      neutral:     "#374151",
      neutralBg:   "#F9FAFB",

      font: "'Inter', 'Noto Sans JP', sans-serif",
      radius: "8px",
      radiusSm: "6px",
      radiusLg: "12px",
    };

    /* ── 共通スタイル ── */
    const S = {
      wrap:    { maxWidth: 480, margin: "0 auto", padding: "0 16px" },
      card:    { background: C.surface, borderRadius: C.radiusLg, border: `1px solid ${C.border}`, padding: "20px" },
      cardLg:  { background: C.surface, borderRadius: C.radiusLg, border: `1px solid ${C.border}`, padding: "28px 24px" },

      /* ボタン */
      btn:    { display: "inline-flex", alignItems: "center", justifyContent: "center", gap: 6,
                padding: "11px 20px", borderRadius: C.radius, fontSize: "0.875rem", fontWeight: 600,
                border: "none", cursor: "pointer", fontFamily: C.font, width: "100%",
                transition: "opacity 0.12s", letterSpacing: "0.01em" },
      btnPrimary: { background: C.primary, color: "#fff" },
      btnGhost:   { background: "transparent", color: C.text, border: `1px solid ${C.border}` },
      btnSuccess: { background: C.success, color: "#fff" },
      btnDanger:  { background: C.danger, color: "#fff" },
      btnWarn:    { background: "#D97706", color: "#fff" },
      btnSm:      { padding: "7px 14px", fontSize: "0.8rem", width: "auto" },

      /* フォーム */
      input:  { width: "100%", padding: "10px 12px", borderRadius: C.radiusSm,
                border: `1px solid ${C.border}`, fontSize: "0.9rem",
                fontFamily: C.font, background: C.bg, outline: "none",
                boxSizing: "border-box", transition: "border-color 0.12s, background 0.12s",
                color: C.text },
      label:  { display: "block", fontSize: "0.75rem", fontWeight: 600,
                color: C.textSub, marginBottom: 5, letterSpacing: "0.03em" },

      /* テキスト */
      h1: { fontSize: "1.65rem", fontWeight: 700, letterSpacing: "-0.02em", lineHeight: 1.25, color: C.text },
      h2: { fontSize: "1.05rem", fontWeight: 700, letterSpacing: "-0.01em", color: C.text },
      sub: { fontSize: "0.83rem", color: C.textSub, lineHeight: 1.65 },

      /* バッジ */
      badge: (bg, color) => ({
        display: "inline-flex", alignItems: "center", padding: "2px 10px",
        borderRadius: 100, fontSize: "0.7rem", fontWeight: 600,
        background: bg, color, letterSpacing: "0.01em",
      }),

      divider: { height: 1, background: C.border, margin: "20px 0" },
      anim: { animation: "fadeIn 0.18s ease" },
    };

    const Field = ({ label, children, hint }) => (
      <div style={{ marginBottom: 16 }}>
        <label style={S.label}>{label}</label>
        {children}
        {hint && <p style={{ fontSize: "0.72rem", color: C.textMuted, marginTop: 4 }}>{hint}</p>}
      </div>
    );

    /* ── ナビゲーション ── */
    function Nav({ goHome, user, logout }) {
      return (
        <div style={{ borderBottom: `1px solid ${C.border}`, background: C.surface }}>
          <div style={{ ...S.wrap, display: "flex", alignItems: "center", justifyContent: "space-between", height: 52 }}>
            <button onClick={goHome} style={{ fontSize: "0.95rem", fontWeight: 700, color: C.primary,
              background: "none", border: "none", fontFamily: C.font, cursor: "pointer", letterSpacing: "-0.01em" }}>
              アツメル
            </button>
            {user && (
              <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                <span style={{ fontSize: "0.72rem", color: C.textMuted }}>{user}</span>
                <button onClick={logout} style={{ ...S.btn, ...S.btnGhost, ...S.btnSm }}>ログアウト</button>
              </div>
            )}
          </div>
        </div>
      );
    }

    /* ── ホーム ── */
    function Home({ go, user }) {
      return (
        <div style={{ ...S.wrap, paddingTop: 48, paddingBottom: 80, ...S.anim }}>
          <div style={{ marginBottom: 40 }}>
            <h1 style={{ ...S.h1, marginBottom: 12 }}>
              出欠も集金も、<br />これひとつで。
            </h1>
            <p style={{ ...S.sub, maxWidth: 300 }}>
              イベントを作ってURLを共有するだけ。<br />出欠確認から集金まで一括管理できます。
            </p>
          </div>

          <div style={{ display: "flex", flexDirection: "column", gap: 10, maxWidth: 300, marginBottom: 52 }}>
            <button style={{ ...S.btn, ...S.btnPrimary }} onClick={() => go(user ? "create" : "login")}>
              イベントをつくる
            </button>
            <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => go(user ? "list" : "login")}>
              マイイベント
            </button>
          </div>

          <div>
            <p style={{ fontSize: "0.7rem", fontWeight: 700, color: C.textMuted, marginBottom: 14,
              letterSpacing: "0.08em", textTransform: "uppercase" }}>使い方</p>
            {[
              { step: "1", t: "イベントを作成", d: "タイトルと日時だけでOK" },
              { step: "2", t: "URLを共有", d: "参加者がそのまま出欠回答" },
              { step: "3", t: "集金を管理", d: "支払い状況をひとめで確認" },
            ].map((x) => (
              <div key={x.step} style={{ display: "flex", alignItems: "flex-start", gap: 14,
                padding: "14px 0", borderBottom: `1px solid ${C.border}` }}>
                <span style={{ minWidth: 22, height: 22, borderRadius: "50%", background: C.primaryBg,
                  color: C.primary, fontSize: "0.72rem", fontWeight: 700,
                  display: "flex", alignItems: "center", justifyContent: "center", marginTop: 1 }}>{x.step}</span>
                <div>
                  <div style={{ fontWeight: 600, fontSize: "0.875rem", color: C.text }}>{x.t}</div>
                  <div style={{ fontSize: "0.78rem", color: C.textSub, marginTop: 2 }}>{x.d}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ── ログイン ── */
    function Login({ go, setUser }) {
      const ref = useRef(null);
      const [ok, setOk] = useState(false);
      const [err, setErr] = useState(false);
      const handle = () => {
        const v = ref.current?.value || "";
        if (!v.includes("@")) { setErr(true); return; }
        setErr(false);
        db.set("atsumeru_user", v);
        setUser(v);
        setOk(true);
        setTimeout(() => go("list"), 700);
      };
      return (
        <div style={{ ...S.wrap, paddingTop: 48, ...S.anim }}>
          <div style={S.cardLg}>
            <h2 style={{ ...S.h2, marginBottom: 4 }}>ログイン</h2>
            <p style={{ ...S.sub, marginBottom: 24 }}>メールアドレスだけで利用できます</p>
            {ok ? (
              <div style={{ textAlign: "center", padding: "24px 0", background: C.successBg,
                borderRadius: C.radius, color: C.success, fontWeight: 600 }}>
                ログインしました
              </div>
            ) : (
              <>
                <Field label="メールアドレス">
                  <input ref={ref} style={{ ...S.input, borderColor: err ? C.danger : C.border }}
                    type="email" inputMode="email" autoCapitalize="none"
                    autoCorrect="off" spellCheck={false} placeholder="you@example.com" defaultValue=""
                    onKeyDown={(e) => e.key === "Enter" && handle()} />
                  {err && <p style={{ fontSize: "0.72rem", color: C.danger, marginTop: 4 }}>正しいメールアドレスを入力してください</p>}
                </Field>
                <button style={{ ...S.btn, ...S.btnPrimary }} onClick={handle}>ログイン</button>
              </>
            )}
          </div>
        </div>
      );
    }

    /* ── イベント作成 ── */
    function Create({ go, user }) {
      const titleRef = useRef(null);
      const dateRef   = useRef(null);
      const placeRef  = useRef(null);
      const noteRef   = useRef(null);
      const [err, setErr] = useState(false);

      const handle = () => {
        const title = titleRef.current?.value?.trim();
        if (!title) { setErr(true); return; }
        setErr(false);
        const ev = {
          id: genId(), title,
          date:  dateRef.current?.value  || "",
          place: placeRef.current?.value || "",
          note:  noteRef.current?.value  || "",
          createdBy: user, createdAt: new Date().toISOString(),
          members: [], collecting: false, amount: 0, payUrl: "",
        };
        const all = db.get("atsumeru_events") || [];
        all.push(ev);
        db.set("atsumeru_events", all);
        go("manage", ev.id);
      };

      return (
        <div style={{ ...S.wrap, paddingTop: 28, paddingBottom: 80, ...S.anim }}>
          <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 20 }}>
            <button style={{ ...S.btn, ...S.btnGhost, ...S.btnSm }} onClick={() => go("list")}>← 戻る</button>
            <h2 style={S.h2}>イベントを作成</h2>
          </div>
          <div style={S.cardLg}>
            <Field label="イベント名 *">
              <input ref={titleRef} style={{ ...S.input, borderColor: err ? C.danger : C.border }}
                type="text" placeholder="例：3月の飲み会" defaultValue=""
                onKeyDown={(e) => e.key === "Enter" && handle()} />
              {err && <p style={{ fontSize: "0.72rem", color: C.danger, marginTop: 4 }}>イベント名を入力してください</p>}
            </Field>
            <Field label="日時（任意）">
              <input ref={dateRef} style={S.input} type="datetime-local" defaultValue="" />
            </Field>
            <Field label="場所（任意）">
              <input ref={placeRef} style={S.input} type="text" placeholder="例：渋谷の居酒屋" defaultValue="" />
            </Field>
            <Field label="メモ（任意）">
              <input ref={noteRef} style={S.input} type="text" placeholder="例：遅刻する場合は連絡を" defaultValue="" />
            </Field>
            <button style={{ ...S.btn, ...S.btnPrimary, marginTop: 4 }} onClick={handle}>作成する</button>
          </div>
        </div>
      );
    }

    /* ── イベント一覧 ── */
    function EventList({ go, user }) {
      const events = (db.get("atsumeru_events") || []).filter((e) => e.createdBy === user);
      return (
        <div style={{ ...S.wrap, paddingTop: 28, paddingBottom: 80, ...S.anim }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 20 }}>
            <h2 style={S.h2}>マイイベント</h2>
            <button style={{ ...S.btn, ...S.btnPrimary, ...S.btnSm }} onClick={() => go("create")}>+ 新規作成</button>
          </div>

          {events.length === 0 ? (
            <div style={{ ...S.cardLg, textAlign: "center", padding: "48px 24px" }}>
              <p style={{ color: C.textMuted, marginBottom: 20, fontSize: "0.875rem" }}>
                まだイベントがありません
              </p>
              <button style={{ ...S.btn, ...S.btnPrimary }} onClick={() => go("create")}>
                最初のイベントを作成
              </button>
            </div>
          ) : (
            <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
              {events.map((ev) => {
                const yes  = ev.members.filter((m) => m.rsvp === "yes").length;
                const paid = ev.members.filter((m) => m.paid).length;
                return (
                  <div key={ev.id} style={{ ...S.card, cursor: "pointer" }} onClick={() => go("manage", ev.id)}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontWeight: 600, fontSize: "0.9rem", marginBottom: 3,
                          whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{ev.title}</div>
                        <div style={{ fontSize: "0.75rem", color: C.textMuted }}>
                          {ev.date ? fmtDate(ev.date) : "日時未定"}{ev.place ? `　${ev.place}` : ""}
                        </div>
                      </div>
                      <div style={{ display: "flex", gap: 6, flexShrink: 0, marginLeft: 10 }}>
                        <span style={S.badge(C.neutralBg, C.textSub)}>参加 {yes}</span>
                        {ev.collecting && (
                          <span style={S.badge(paid === yes && yes > 0 ? C.successBg : C.warnBg,
                            paid === yes && yes > 0 ? C.success : C.warn)}>
                            集金 {paid}/{yes}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    /* ── メンバー行（幹事用） ── */
    function MemberRow({ m, onRemove }) {
      return (
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between",
          padding: "9px 0", borderBottom: `1px solid ${C.border}` }}>
          <span style={{ fontSize: "0.875rem", color: C.text }}>{m.name}</span>
          <button onClick={(e) => { e.stopPropagation(); onRemove(); }}
            style={{ background: "none", border: "none", color: C.textMuted,
              fontSize: "0.75rem", cursor: "pointer", fontFamily: C.font, padding: "3px 6px" }}>削除</button>
        </div>
      );
    }

    /* ── 管理画面 ── */
    function Manage({ eventId, go }) {
      const [ev, setEv]           = useState(null);
      const [tab, setTab]         = useState("rsvp");
      const [showSetup, setShowSetup] = useState(false);
      const amountRef  = useRef(null);
      const payUrlRef  = useRef(null);

      const load = () => {
        const all = db.get("atsumeru_events") || [];
        setEv(all.find((e) => e.id === eventId) || null);
      };
      useEffect(() => {
        load();
        const onStorage = (e) => { if (e.key === "atsumeru_events") load(); };
        window.addEventListener("storage", onStorage);
        const timer = setInterval(load, 1000);
        return () => { window.removeEventListener("storage", onStorage); clearInterval(timer); };
      }, [eventId]);

      const save = (updated) => {
        const all = db.get("atsumeru_events") || [];
        const idx = all.findIndex((e) => e.id === eventId);
        if (idx >= 0) all[idx] = updated;
        db.set("atsumeru_events", all);
        setEv(updated);
      };

      const copyLink = () => {
        const url = `${window.location.origin}${window.location.pathname}?event=${eventId}`;
        navigator.clipboard?.writeText(url).then(() => {
          alert("URLをコピーしました。参加者に送ってください。\n\n" + url);
        }).catch(() => { prompt("このURLを参加者に送ってください：", url); });
      };

      const startCollecting = () => {
        const amount = Number(amountRef.current?.value);
        const payUrl = payUrlRef.current?.value?.trim() || "";
        if (!amount || amount <= 0) return;
        save({ ...ev, collecting: true, amount, payUrl });
        setShowSetup(false);
      };

      const togglePaid = (memberId) => {
        save({
          ...ev,
          members: ev.members.map((m) =>
            m.id === memberId
              ? { ...m, paid: !m.paid, paidAt: !m.paid ? new Date().toISOString() : null }
              : m
          ),
        });
      };

      const removeMember = (memberId) => {
        save({ ...ev, members: ev.members.filter((m) => m.id !== memberId) });
      };

      if (!ev) return null;

      const yesMembers   = ev.members.filter((m) => m.rsvp === "yes");
      const noMembers    = ev.members.filter((m) => m.rsvp === "no");
      const maybeMembers = ev.members.filter((m) => m.rsvp === "maybe");
      const paidCount    = yesMembers.filter((m) => m.paid).length;

      return (
        <div style={{ ...S.wrap, paddingTop: 20, paddingBottom: 80, ...S.anim }}>
          <button style={{ ...S.btn, ...S.btnGhost, ...S.btnSm, marginBottom: 16 }} onClick={() => go("list")}>← 一覧</button>

          {/* イベント情報 */}
          <div style={{ ...S.card, marginBottom: 12 }}>
            <h2 style={{ ...S.h2, marginBottom: 4 }}>{ev.title}</h2>
            <p style={{ fontSize: "0.78rem", color: C.textMuted }}>
              {ev.date ? fmtDate(ev.date) : "日時未定"}{ev.place ? `　${ev.place}` : ""}
            </p>
            {ev.note && <p style={{ fontSize: "0.78rem", color: C.textSub, marginTop: 6 }}>{ev.note}</p>}
            <div style={S.divider} />
            <button style={{ ...S.btn, ...S.btnGhost }} onClick={copyLink}>
              参加者にURLを共有する
            </button>
          </div>

          {/* タブ */}
          <div style={{ display: "flex", gap: 0, marginBottom: 12, border: `1px solid ${C.border}`,
            borderRadius: C.radius, overflow: "hidden", background: C.surface }}>
            {[
              { key: "rsvp",    label: `出欠　${ev.members.length}名` },
              { key: "collect", label: ev.collecting ? `集金　${paidCount}/${yesMembers.length}` : "集金" },
            ].map((t) => (
              <button key={t.key} onClick={() => setTab(t.key)} style={{
                flex: 1, padding: "10px 0", fontSize: "0.82rem", fontWeight: 600,
                border: "none", cursor: "pointer", fontFamily: C.font, letterSpacing: "0.01em",
                background: tab === t.key ? C.primary : "transparent",
                color:      tab === t.key ? "#fff" : C.textSub,
                transition: "all 0.15s",
              }}>
                {t.label}
              </button>
            ))}
          </div>

          {/* 出欠タブ */}
          {tab === "rsvp" && (
            <div style={S.card}>
              {ev.members.length === 0 ? (
                <div style={{ padding: "28px 0", textAlign: "center" }}>
                  <p style={{ color: C.textMuted, fontSize: "0.875rem" }}>まだ回答がありません</p>
                  <p style={{ color: C.textMuted, fontSize: "0.78rem", marginTop: 6 }}>URLを共有して参加者を集めましょう</p>
                </div>
              ) : (
                <>
                  {[
                    { list: yesMembers,   label: `参加　${yesMembers.length}名`,   color: C.success },
                    { list: noMembers,    label: `不参加　${noMembers.length}名`,  color: C.danger  },
                    { list: maybeMembers, label: `未定　${maybeMembers.length}名`, color: C.warn    },
                  ].filter(g => g.list.length > 0).map((g, i) => (
                    <div key={i} style={{ marginBottom: 16 }}>
                      <div style={{ fontSize: "0.72rem", fontWeight: 700, color: g.color,
                        marginBottom: 6, letterSpacing: "0.03em" }}>{g.label}</div>
                      {g.list.map((m) => (
                        <MemberRow key={m.id} m={m} onRemove={() => removeMember(m.id)} />
                      ))}
                    </div>
                  ))}
                </>
              )}
            </div>
          )}

          {/* 集金タブ */}
          {tab === "collect" && (
            <div style={S.card}>
              {!ev.collecting ? (
                showSetup ? (
                  <>
                    <h3 style={{ fontWeight: 700, fontSize: "0.9rem", marginBottom: 16, color: C.text }}>集金設定</h3>
                    <Field label="1人あたりの金額（円）*">
                      <input ref={amountRef} style={S.input} type="number" inputMode="numeric" placeholder="4500" defaultValue="" />
                    </Field>
                    <Field label="送金先URL（PayPayなど・任意）" hint="入力すると参加者に送金ボタンが表示されます">
                      <input ref={payUrlRef} style={S.input} type="url" inputMode="url"
                        autoCapitalize="none" autoCorrect="off" spellCheck={false}
                        placeholder="https://pay.paypay.ne.jp/..." defaultValue="" />
                    </Field>
                    <div style={{ display: "flex", gap: 8, marginTop: 4 }}>
                      <button style={{ ...S.btn, ...S.btnGhost, flex: 1 }} onClick={() => setShowSetup(false)}>キャンセル</button>
                      <button style={{ ...S.btn, ...S.btnPrimary, flex: 1 }} onClick={startCollecting}>集金を開始</button>
                    </div>
                  </>
                ) : (
                  <div style={{ padding: "24px 0", textAlign: "center" }}>
                    <p style={{ color: C.textSub, fontSize: "0.875rem", marginBottom: 20 }}>
                      出欠が集まったら集金を開始できます
                    </p>
                    <button style={{ ...S.btn, ...S.btnPrimary }} onClick={() => {
                      if (yesMembers.length === 0) { alert("まだ参加者がいません"); return; }
                      setShowSetup(true);
                    }}>集金を設定する</button>
                  </div>
                )
              ) : (
                <>
                  {/* 進捗ヘッダー */}
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                    <span style={{ fontWeight: 700, fontSize: "1rem", color: C.text }}>
                      ¥{ev.amount.toLocaleString()}
                      <span style={{ fontWeight: 400, fontSize: "0.78rem", color: C.textMuted }}> / 人</span>
                    </span>
                    <span style={S.badge(
                      paidCount === yesMembers.length ? C.successBg : C.warnBg,
                      paidCount === yesMembers.length ? C.success   : C.warn
                    )}>{paidCount}/{yesMembers.length} 完了</span>
                  </div>

                  {/* プログレスバー */}
                  <div style={{ background: C.bg, borderRadius: 4, height: 6, marginBottom: 18, overflow: "hidden" }}>
                    <div style={{
                      height: "100%", borderRadius: 4, transition: "width 0.4s ease",
                      width: yesMembers.length > 0 ? `${(paidCount / yesMembers.length) * 100}%` : "0%",
                      background: paidCount === yesMembers.length ? C.success : C.primary,
                    }} />
                  </div>

                  {/* メンバーリスト */}
                  {yesMembers.map((m) => (
                    <div key={m.id} onClick={() => togglePaid(m.id)} style={{
                      display: "flex", alignItems: "center", justifyContent: "space-between",
                      padding: "11px 0", borderBottom: `1px solid ${C.border}`,
                      cursor: "pointer", userSelect: "none",
                    }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                        <div style={{
                          width: 20, height: 20, borderRadius: 4,
                          border: m.paid ? "none" : `1.5px solid ${C.borderDark}`,
                          background: m.paid ? C.success : "transparent",
                          color: "#fff", display: "flex", alignItems: "center", justifyContent: "center",
                          fontSize: 11, fontWeight: 700, transition: "all 0.15s", flexShrink: 0,
                        }}>{m.paid ? "✓" : ""}</div>
                        <span style={{ fontSize: "0.875rem", color: m.paid ? C.textMuted : C.text,
                          textDecoration: m.paid ? "line-through" : "none" }}>{m.name}</span>
                      </div>
                      <span style={S.badge(
                        m.paid ? C.successBg : C.warnBg,
                        m.paid ? C.success   : C.warn
                      )}>{m.paid ? "済み" : "未払い"}</span>
                    </div>
                  ))}

                  <div style={{ marginTop: 14, fontSize: "0.78rem", color: C.textMuted, textAlign: "right" }}>
                    合計 ¥{(paidCount * ev.amount).toLocaleString()} / ¥{(yesMembers.length * ev.amount).toLocaleString()}
                  </div>
                </>
              )}
            </div>
          )}
        </div>
      );
    }

    /* ── 参加者ページ ── */
    function ParticipantPage({ eventId }) {
      const [ev, setEv]       = useState(null);
      const [step, setStep]   = useState("rsvp");
      const [myName, setMyName] = useState("");
      const nameRef = useRef(null);

      const load = () => {
        const all = db.get("atsumeru_events") || [];
        setEv(all.find((e) => e.id === eventId) || null);
      };
      useEffect(() => {
        load();
        const onStorage = (e) => { if (e.key === "atsumeru_events") load(); };
        window.addEventListener("storage", onStorage);
        const timer = setInterval(load, 1000);
        return () => { window.removeEventListener("storage", onStorage); clearInterval(timer); };
      }, [eventId]);

      useEffect(() => {
        if (step !== "paying") return;
        const h = () => { if (document.visibilityState === "visible") setStep("confirm"); };
        const f = () => setStep("confirm");
        document.addEventListener("visibilitychange", h);
        window.addEventListener("focus", f);
        return () => { document.removeEventListener("visibilitychange", h); window.removeEventListener("focus", f); };
      }, [step]);

      const submitRsvp = (rsvp) => {
        const name = nameRef.current?.value?.trim();
        if (!name) { alert("名前を入力してください"); return; }
        const all = db.get("atsumeru_events") || [];
        const updated = all.map((e) => {
          if (e.id !== eventId) return e;
          const existing = e.members.find((m) => m.name === name);
          if (existing) return { ...e, members: e.members.map((m) => m.name === name ? { ...m, rsvp } : m) };
          return { ...e, members: [...e.members, { id: genId(), name, rsvp, paid: false, paidAt: null }] };
        });
        db.set("atsumeru_events", updated);
        setMyName(name);
        setEv(updated.find((e) => e.id === eventId));
        setStep("rsvp_done");
      };

      const openPayLink = () => {
        setStep("paying");
        setTimeout(() => { window.open(ev.payUrl, "_blank"); }, 100);
      };

      const confirmPaid = () => {
        const all = db.get("atsumeru_events") || [];
        const updated = all.map((e) => {
          if (e.id !== eventId) return e;
          return { ...e, members: e.members.map((m) =>
            m.name === myName ? { ...m, paid: true, paidAt: new Date().toISOString() } : m
          )};
        });
        db.set("atsumeru_events", updated);
        setStep("done");
      };

      /* あとから支払い */
      const handlePayLater = () => {
        const name = nameRef.current?.value?.trim();
        if (!name) { alert("名前を入力してください"); return; }
        const member = ev.members.find((m) => m.name === name);
        if (!member) { alert("その名前での回答が見つかりません。\n先に出欠を回答してください。"); return; }
        if (member.rsvp !== "yes") { alert("参加回答している方のみ支払いできます。"); return; }
        if (member.paid) { alert("すでに支払い済みです。"); return; }
        setMyName(name);
        if (ev.payUrl) { openPayLink(); } else { setStep("confirm"); }
      };

      /* ヘッダー（参加者ページ共通） */
      const Header = () => (
        <div style={{ borderBottom: `1px solid ${C.border}`, background: C.surface, marginBottom: 24 }}>
          <div style={{ ...S.wrap, height: 52, display: "flex", alignItems: "center" }}>
            <span style={{ fontSize: "0.9rem", fontWeight: 700, color: C.primary }}>アツメル</span>
          </div>
        </div>
      );

      if (!ev) return (
        <>
          <Header />
          <div style={{ ...S.wrap, textAlign: "center", paddingTop: 48 }}>
            <div style={S.cardLg}>
              <p style={{ color: C.textSub }}>イベントが見つかりません</p>
            </div>
          </div>
        </>
      );

      if (step === "done") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingTop: 24, ...S.anim }}>
            <div style={{ ...S.cardLg, textAlign: "center", padding: "44px 24px",
              borderColor: C.success }}>
              <div style={{ fontSize: "0.75rem", fontWeight: 700, color: C.success,
                letterSpacing: "0.06em", marginBottom: 12 }}>完了</div>
              <h2 style={{ ...S.h2, marginBottom: 8 }}>支払いを報告しました</h2>
              <p style={S.sub}>幹事さんに反映されました。ありがとうございます。</p>
            </div>
          </div>
        </>
      );

      if (step === "confirm") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingTop: 24, ...S.anim }}>
            <div style={{ ...S.cardLg, textAlign: "center" }}>
              <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.textMuted,
                letterSpacing: "0.06em", marginBottom: 12 }}>確認</p>
              <h2 style={{ ...S.h2, marginBottom: 8 }}>送金は完了しましたか？</h2>
              <p style={{ ...S.sub, marginBottom: 28 }}>{myName}さんの支払いを記録します</p>
              <button style={{ ...S.btn, ...S.btnSuccess, marginBottom: 10 }} onClick={confirmPaid}>
                はい、送金しました
              </button>
              <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => setStep("rsvp_done")}>まだしていない</button>
            </div>
          </div>
        </>
      );

      if (step === "paying") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingTop: 24, textAlign: "center", ...S.anim }}>
            <div style={S.cardLg}>
              <div style={{ width: 36, height: 36, borderRadius: "50%",
                border: `2px solid ${C.border}`, borderTopColor: C.primary,
                animation: "spin 0.9s linear infinite", margin: "0 auto 20px" }} />
              <h2 style={{ ...S.h2, marginBottom: 8 }}>送金アプリを開いています</h2>
              <p style={{ ...S.sub, marginBottom: 24 }}>送金が終わったらこのページに戻ってきてください</p>
              <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => setStep("confirm")}>送金が終わった</button>
            </div>
          </div>
        </>
      );

      const yesMembers = ev.members.filter((m) => m.rsvp === "yes");
      const myMember   = myName ? ev.members.find((m) => m.name === myName) : null;

      /* 回答済み画面 */
      if (step === "rsvp_done") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingBottom: 60, ...S.anim }}>
            <div style={S.cardLg}>
              <div style={{ textAlign: "center", marginBottom: 20 }}>
                <div style={{ display: "inline-flex", alignItems: "center", justifyContent: "center",
                  width: 40, height: 40, borderRadius: "50%", background: C.successBg,
                  color: C.success, fontSize: "1rem", marginBottom: 12 }}>✓</div>
                <h2 style={{ ...S.h2, marginBottom: 4 }}>回答しました</h2>
                <p style={{ fontSize: "0.8rem", color: C.textMuted }}>
                  {myName}さん ／ {myMember?.rsvp === "yes" ? "参加" : myMember?.rsvp === "no" ? "不参加" : "未定"}
                </p>
              </div>

              {ev.collecting && myMember?.rsvp === "yes" && !myMember?.paid && (
                <div style={{ background: C.bg, borderRadius: C.radius, padding: 18, marginBottom: 4 }}>
                  <div style={{ textAlign: "center", marginBottom: 14 }}>
                    <div style={{ fontSize: "1.5rem", fontWeight: 700, color: C.text, letterSpacing: "-0.02em" }}>
                      ¥{ev.amount.toLocaleString()}
                    </div>
                    <p style={{ fontSize: "0.72rem", color: C.textMuted, marginTop: 2 }}>お支払い金額</p>
                  </div>
                  {ev.payUrl
                    ? <button style={{ ...S.btn, background: "#E00020", color: "#fff" }} onClick={openPayLink}>PayPayで送金する</button>
                    : <button style={{ ...S.btn, ...S.btnPrimary }} onClick={() => setStep("confirm")}>送金したので報告する</button>
                  }
                </div>
              )}

              {ev.collecting && myMember?.paid && (
                <div style={{ background: C.successBg, borderRadius: C.radius, padding: 16, textAlign: "center", marginBottom: 4 }}>
                  <span style={{ fontSize: "0.875rem", fontWeight: 600, color: C.success }}>支払い済みです</span>
                </div>
              )}

              {yesMembers.length > 0 && (
                <div style={{ marginTop: 20, borderTop: `1px solid ${C.border}`, paddingTop: 16 }}>
                  <p style={{ fontSize: "0.72rem", fontWeight: 700, color: C.textMuted,
                    marginBottom: 8, letterSpacing: "0.03em" }}>参加者　{yesMembers.length}名</p>
                  {yesMembers.map((m) => (
                    <div key={m.id} style={{ display: "flex", alignItems: "center",
                      justifyContent: "space-between", padding: "6px 0" }}>
                      <span style={{ fontSize: "0.85rem", color: C.text }}>{m.name}</span>
                      {ev.collecting && (
                        <span style={S.badge(m.paid ? C.successBg : C.warnBg, m.paid ? C.success : C.warn)}>
                          {m.paid ? "済" : "未"}
                        </span>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </>
      );

      /* 出欠回答フォーム */
      return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingBottom: 60, ...S.anim }}>
            <div style={S.cardLg}>
              {/* イベント情報 */}
              <h2 style={{ ...S.h2, marginBottom: 4 }}>{ev.title}</h2>
              <p style={{ fontSize: "0.78rem", color: C.textMuted, marginBottom: 2 }}>
                {ev.date ? fmtDate(ev.date) : "日時未定"}{ev.place ? `　${ev.place}` : ""}
              </p>
              {ev.note && <p style={{ fontSize: "0.78rem", color: C.textSub, marginTop: 4 }}>{ev.note}</p>}

              <div style={S.divider} />

              {/* 出欠フォーム */}
              <p style={{ fontWeight: 600, fontSize: "0.875rem", marginBottom: 14, color: C.text }}>出欠を回答する</p>
              <Field label="名前">
                <input ref={nameRef} style={S.input} type="text" placeholder="お名前" defaultValue="" />
              </Field>
              <div style={{ display: "flex", gap: 8 }}>
                <button style={{ ...S.btn, ...S.btnSuccess, flex: 1 }} onClick={() => submitRsvp("yes")}>参加</button>
                <button style={{ ...S.btn, ...S.btnWarn,   flex: 1 }} onClick={() => submitRsvp("maybe")}>未定</button>
                <button style={{ ...S.btn, ...S.btnDanger, flex: 1 }} onClick={() => submitRsvp("no")}>不参加</button>
              </div>

              {/* あとから支払うセクション */}
              {ev.collecting && (
                <div style={{ marginTop: 20, padding: "14px 16px", background: C.bg,
                  borderRadius: C.radius, border: `1px solid ${C.border}` }}>
                  <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.textSub, marginBottom: 4 }}>
                    あとから支払う方へ
                  </p>
                  <p style={{ fontSize: "0.72rem", color: C.textMuted, marginBottom: 12 }}>
                    上の欄に名前を入力してボタンを押してください
                  </p>
                  <button style={{ ...S.btn, ...S.btnPrimary }} onClick={handlePayLater}>
                    支払いページへ（¥{ev.amount.toLocaleString()}）
                  </button>
                </div>
              )}

              {/* 回答状況 */}
              {ev.members.length > 0 && (
                <div style={{ marginTop: 24, borderTop: `1px solid ${C.border}`, paddingTop: 16 }}>
                  <p style={{ fontSize: "0.72rem", fontWeight: 700, color: C.textMuted,
                    marginBottom: 8, letterSpacing: "0.03em" }}>回答状況　{ev.members.length}名</p>
                  {ev.members.map((m) => (
                    <div key={m.id} style={{ display: "flex", alignItems: "center",
                      justifyContent: "space-between", padding: "6px 0" }}>
                      <span style={{ fontSize: "0.85rem", color: C.text }}>{m.name}</span>
                      <span style={S.badge(
                        m.rsvp === "yes" ? C.successBg : m.rsvp === "no" ? C.dangerBg : C.warnBg,
                        m.rsvp === "yes" ? C.success   : m.rsvp === "no" ? C.danger   : C.warn,
                      )}>{m.rsvp === "yes" ? "参加" : m.rsvp === "no" ? "不参加" : "未定"}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </>
      );
    }

    /* ── アプリルート ── */
    function App() {
      const [page, setPage]     = useState("home");
      const [pageArg, setPageArg] = useState(null);
      const [user, setUser]     = useState(null);

      const go = (p, arg) => { setPage(p); setPageArg(arg || null); };

      useEffect(() => {
        const saved = db.get("atsumeru_user");
        if (saved) setUser(saved);
        const params = new URLSearchParams(window.location.search);
        const eid = params.get("event");
        if (eid) { setPage("participant"); setPageArg(eid); }
      }, []);

      const logout = () => { setUser(null); db.set("atsumeru_user", null); go("home"); };

      return (
        <div style={{ fontFamily: C.font, background: C.bg, color: C.text,
          minHeight: "100vh", lineHeight: 1.6, WebkitFontSmoothing: "antialiased" }}>
          {page !== "participant" && <Nav goHome={() => go("home")} user={user} logout={logout} />}
          {page === "participant" && <ParticipantPage eventId={pageArg} />}
          {page === "home"        && <Home go={go} user={user} />}
          {page === "login"       && <Login go={go} setUser={setUser} />}
          {page === "create"      && <Create go={go} user={user} />}
          {page === "list"        && <EventList go={go} user={user} />}
          {page === "manage"      && <Manage eventId={pageArg} go={go} />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
