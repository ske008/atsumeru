<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>アチE��ル</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { font-size: 16px; }
    body { background: #F5F4F1; -webkit-font-smoothing: antialiased; min-height: 100vh; padding-bottom: env(safe-area-inset-bottom); }
    input, button, select, textarea { font-size: 16px !important; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    input:focus { border-color: #2D5A3D !important; background: #fff !important; }
    button:hover { opacity: 0.88; }
    button:active { opacity: 0.72; transform: scale(0.98); }
    .rsvp-actions { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; }
    @media (max-width: 420px) { .rsvp-actions { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div style='padding:8px 12px;background:#e6f5ee;border-bottom:1px solid #b7e1cb;font-family:sans-serif;font-size:14px;'>�V�ł͂�����: <a href='/' style='color:#0b4f32;font-weight:700;'>Next�ł��J��</a></div>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const genId = () => Math.random().toString(36).slice(2, 10);
    const fmtDate = (d) => new Date(d).toLocaleDateString("ja-JP", { year: "numeric", month: "long", day: "numeric" });

    const db = {
      get: (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    };

    /* ── チE��イント�Eクン ── */
    const C = {
      bg:          "#F5F4F1",
      surface:     "#FFFFFF",
      border:      "#E2E0DB",
      borderDark:  "#C8C6BF",
      text:        "#1C1C1A",
      textSub:     "#6B6B67",
      textMuted:   "#A0A09C",

      primary:     "#2D5A3D",   /* 深緁E*/
      primaryBg:   "#EEF4F0",
      primaryText: "#1A3D28",

      danger:      "#B91C1C",
      dangerBg:    "#FEF2F2",

      warn:        "#92400E",
      warnBg:      "#FFFBEB",

      success:     "#166534",
      successBg:   "#F0FDF4",

      neutral:     "#374151",
      neutralBg:   "#F9FAFB",

      font: "'Inter', 'Noto Sans JP', sans-serif",
      radius: "8px",
      radiusSm: "6px",
      radiusLg: "12px",
    };

    /* ── 共通スタイル ── */
    const S = {
      wrap:    {
        maxWidth: 480, margin: "0 auto", width: "100%",
        paddingLeft: "max(16px, env(safe-area-inset-left))",
        paddingRight: "max(16px, env(safe-area-inset-right))"
      },
      card:    { background: C.surface, borderRadius: C.radiusLg, border: `1px solid ${C.border}`, padding: "20px" },
      cardLg:  { background: C.surface, borderRadius: C.radiusLg, border: `1px solid ${C.border}`, padding: "28px 24px" },

      /* ボタン */
      btn:    { display: "inline-flex", alignItems: "center", justifyContent: "center", gap: 6,
                padding: "11px 20px", borderRadius: C.radius, fontSize: "0.875rem", fontWeight: 600,
                border: "none", cursor: "pointer", fontFamily: C.font, width: "100%",
                transition: "opacity 0.12s", letterSpacing: "0.01em" },
      btnPrimary: { background: C.primary, color: "#fff" },
      btnGhost:   { background: "transparent", color: C.text, border: `1px solid ${C.border}` },
      btnSuccess: { background: C.success, color: "#fff" },
      btnDanger:  { background: C.danger, color: "#fff" },
      btnWarn:    { background: "#D97706", color: "#fff" },
      btnSm:      { padding: "7px 14px", fontSize: "0.8rem", width: "auto" },

      /* フォーム */
      input:  { width: "100%", padding: "10px 12px", borderRadius: C.radiusSm,
                border: `1px solid ${C.border}`, fontSize: "0.9rem",
                fontFamily: C.font, background: C.bg, outline: "none",
                boxSizing: "border-box", transition: "border-color 0.12s, background 0.12s",
                color: C.text },
      label:  { display: "block", fontSize: "0.75rem", fontWeight: 600,
                color: C.textSub, marginBottom: 5, letterSpacing: "0.03em" },

      /* チE��スチE*/
      h1: { fontSize: "1.65rem", fontWeight: 700, letterSpacing: "-0.02em", lineHeight: 1.25, color: C.text },
      h2: { fontSize: "1.05rem", fontWeight: 700, letterSpacing: "-0.01em", color: C.text },
      sub: { fontSize: "0.83rem", color: C.textSub, lineHeight: 1.65 },

      /* バッジ */
      badge: (bg, color) => ({
        display: "inline-flex", alignItems: "center", padding: "2px 10px",
        borderRadius: 100, fontSize: "0.7rem", fontWeight: 600,
        background: bg, color, letterSpacing: "0.01em",
      }),

      divider: { height: 1, background: C.border, margin: "20px 0" },
      anim: { animation: "fadeIn 0.18s ease" },
    };

    const Field = ({ label, children, hint }) => (
      <div style={{ marginBottom: 16 }}>
        <label style={S.label}>{label}</label>
        {children}
        {hint && <p style={{ fontSize: "0.72rem", color: C.textMuted, marginTop: 4 }}>{hint}</p>}
      </div>
    );

    /* ── ナビゲーション ── */
    function Nav({ goHome, user, logout }) {
      return (
        <div style={{ borderBottom: `1px solid ${C.border}`, background: C.surface }}>
          <div style={{ ...S.wrap, display: "flex", alignItems: "center", justifyContent: "space-between", height: 52 }}>
            <button onClick={goHome} style={{ fontSize: "0.95rem", fontWeight: 700, color: C.primary,
              background: "none", border: "none", fontFamily: C.font, cursor: "pointer", letterSpacing: "-0.01em" }}>
              アチE��ル
            </button>
            {user && (
              <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                <span style={{ fontSize: "0.72rem", color: C.textMuted }}>{user}</span>
                <button onClick={logout} style={{ ...S.btn, ...S.btnGhost, ...S.btnSm }}>ログアウチE/button>
              </div>
            )}
          </div>
        </div>
      );
    }

    /* ── ホ�Eム ── */
    function Home({ go, user }) {
      return (
        <div style={{ ...S.wrap, paddingTop: 48, paddingBottom: 80, ...S.anim }}>
          <div style={{ marginBottom: 40 }}>
            <h1 style={{ ...S.h1, marginBottom: 12 }}>
              出欠も集金も、Ebr />これひとつで、E
            </h1>
            <p style={{ ...S.sub, maxWidth: 300 }}>
              イベントを作ってURLを�E有するだけ、Ebr />出欠確認から集金まで一括管琁E��きます、E
            </p>
          </div>

          <div style={{ display: "flex", flexDirection: "column", gap: 10, maxWidth: 300, marginBottom: 52 }}>
            <button style={{ ...S.btn, ...S.btnPrimary }} onClick={() => go(user ? "create" : "login")}>
              イベントをつくる
            </button>
            <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => go(user ? "list" : "login")}>
              マイイベンチE
            </button>
          </div>

          <div>
            <p style={{ fontSize: "0.7rem", fontWeight: 700, color: C.textMuted, marginBottom: 14,
              letterSpacing: "0.08em", textTransform: "uppercase" }}>使ぁE��</p>
            {[
              { step: "1", t: "イベントを作�E", d: "タイトルと日時だけでOK" },
              { step: "2", t: "URLを�E朁E, d: "参加老E��そ�Eまま出欠回筁E },
              { step: "3", t: "雁E��を管琁E, d: "支払い状況をひとめで確誁E },
            ].map((x) => (
              <div key={x.step} style={{ display: "flex", alignItems: "flex-start", gap: 14,
                padding: "14px 0", borderBottom: `1px solid ${C.border}` }}>
                <span style={{ minWidth: 22, height: 22, borderRadius: "50%", background: C.primaryBg,
                  color: C.primary, fontSize: "0.72rem", fontWeight: 700,
                  display: "flex", alignItems: "center", justifyContent: "center", marginTop: 1 }}>{x.step}</span>
                <div>
                  <div style={{ fontWeight: 600, fontSize: "0.875rem", color: C.text }}>{x.t}</div>
                  <div style={{ fontSize: "0.78rem", color: C.textSub, marginTop: 2 }}>{x.d}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ── ログイン ── */
    function Login({ go, setUser }) {
      const ref = useRef(null);
      const [ok, setOk] = useState(false);
      const [err, setErr] = useState(false);
      const handle = () => {
        const v = ref.current?.value || "";
        if (!v.includes("@")) { setErr(true); return; }
        setErr(false);
        db.set("atsumeru_user", v);
        setUser(v);
        setOk(true);
        setTimeout(() => go("list"), 700);
      };
      return (
        <div style={{ ...S.wrap, paddingTop: 48, ...S.anim }}>
          <div style={S.cardLg}>
            <h2 style={{ ...S.h2, marginBottom: 4 }}>ログイン</h2>
            <p style={{ ...S.sub, marginBottom: 24 }}>メールアドレスだけで利用できまぁE/p>
            {ok ? (
              <div style={{ textAlign: "center", padding: "24px 0", background: C.successBg,
                borderRadius: C.radius, color: C.success, fontWeight: 600 }}>
                ログインしました
              </div>
            ) : (
              <>
                <Field label="メールアドレス">
                  <input ref={ref} style={{ ...S.input, borderColor: err ? C.danger : C.border }}
                    type="email" inputMode="email" autoCapitalize="none"
                    autoCorrect="off" spellCheck={false} placeholder="you@example.com" defaultValue=""
                    onKeyDown={(e) => e.key === "Enter" && handle()} />
                  {err && <p style={{ fontSize: "0.72rem", color: C.danger, marginTop: 4 }}>正しいメールアドレスを�E力してください</p>}
                </Field>
                <button style={{ ...S.btn, ...S.btnPrimary }} onClick={handle}>ログイン</button>
              </>
            )}
          </div>
        </div>
      );
    }

    /* ── イベント作�E ── */
    function Create({ go, user }) {
      const titleRef = useRef(null);
      const dateRef   = useRef(null);
      const placeRef  = useRef(null);
      const noteRef   = useRef(null);
      const amountRef = useRef(null);
      const payUrlRef = useRef(null);
      const [err, setErr] = useState(false);
      const [enableCollect, setEnableCollect] = useState(false);

      const handle = () => {
        const title = titleRef.current?.value?.trim();
        if (!title) { setErr(true); return; }
        setErr(false);
        const amount = enableCollect ? (Number(amountRef.current?.value) || 0) : 0;
        const payUrl = enableCollect ? (payUrlRef.current?.value?.trim() || "") : "";
        const ev = {
          id: genId(), title,
          date:  dateRef.current?.value  || "",
          place: placeRef.current?.value || "",
          note:  noteRef.current?.value  || "",
          createdBy: user, createdAt: new Date().toISOString(),
          members: [], collecting: enableCollect && amount > 0, amount, payUrl,
        };
        const all = db.get("atsumeru_events") || [];
        all.push(ev);
        db.set("atsumeru_events", all);
        go("manage", ev.id);
      };

      return (
        <div style={{ ...S.wrap, paddingTop: 28, paddingBottom: 80, ...S.anim }}>
          <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 20 }}>
            <button style={{ ...S.btn, ...S.btnGhost, ...S.btnSm }} onClick={() => go("list")}>ↁE戻めE/button>
            <h2 style={S.h2}>イベントを作�E</h2>
          </div>
          <div style={S.cardLg}>
            <Field label="イベント名 *">
              <input ref={titleRef} style={{ ...S.input, borderColor: err ? C.danger : C.border }}
                type="text" placeholder="例！E月�E飲み企E defaultValue=""
                onKeyDown={(e) => e.key === "Enter" && handle()} />
              {err && <p style={{ fontSize: "0.72rem", color: C.danger, marginTop: 4 }}>イベント名を�E力してください</p>}
            </Field>
            <Field label="日時（任意！E>
              <input ref={dateRef} style={S.input} type="datetime-local" defaultValue="" />
            </Field>
            <Field label="場所�E�任意！E>
              <input ref={placeRef} style={S.input} type="text" placeholder="例：渋谷の屁E�E屁E defaultValue="" />
            </Field>
            <Field label="メモ（任意）">
              <input ref={noteRef} style={S.input} type="text" placeholder="例：遅刻する場合は連絡を" defaultValue="" />
            </Field>
            <div style={{ marginBottom: 16 }}>
              <label style={{ display: "flex", alignItems: "center", gap: 8, cursor: "pointer", fontSize: "0.875rem", color: C.text }}>
                <input type="checkbox" checked={enableCollect} onChange={(e) => setEnableCollect(e.target.checked)} />
                集金を設定する
              </label>
            </div>
            {enableCollect && (
              <>
                <Field label="1人あたりの金額">
                  <input ref={amountRef} style={S.input} type="number" inputMode="numeric" placeholder="4500" defaultValue="" />
                </Field>
                <Field label="送金URL（PayPayなど・任意）" hint="入力すると参加者に送金ボタンが表示されます">
                  <input ref={payUrlRef} style={S.input} type="url" inputMode="url"
                    autoCapitalize="none" autoCorrect="off" spellCheck={false}
                    placeholder="https://pay.paypay.ne.jp/..." defaultValue="" />
                </Field>
              </>
            )}
            <button style={{ ...S.btn, ...S.btnPrimary, marginTop: 4 }} onClick={handle}>作成する</button>
          </div>
        </div>
      );
    }

    /* ── イベント一覧 ── */
    function EventList({ go, user }) {
      const events = (db.get("atsumeru_events") || []).filter((e) => e.createdBy === user);
      return (
        <div style={{ ...S.wrap, paddingTop: 28, paddingBottom: 80, ...S.anim }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 20 }}>
            <h2 style={S.h2}>マイイベンチE/h2>
            <button style={{ ...S.btn, ...S.btnPrimary, ...S.btnSm }} onClick={() => go("create")}>+ 新規作�E</button>
          </div>

          {events.length === 0 ? (
            <div style={{ ...S.cardLg, textAlign: "center", padding: "48px 24px" }}>
              <p style={{ color: C.textMuted, marginBottom: 20, fontSize: "0.875rem" }}>
                まだイベントがありません
              </p>
              <button style={{ ...S.btn, ...S.btnPrimary }} onClick={() => go("create")}>
                最初�Eイベントを作�E
              </button>
            </div>
          ) : (
            <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
              {events.map((ev) => {
                const yes  = ev.members.filter((m) => m.rsvp === "yes").length;
                const paid = ev.members.filter((m) => m.paid).length;
                return (
                  <div key={ev.id} style={{ ...S.card, cursor: "pointer" }} onClick={() => go("manage", ev.id)}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontWeight: 600, fontSize: "0.9rem", marginBottom: 3,
                          whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{ev.title}</div>
                        <div style={{ fontSize: "0.75rem", color: C.textMuted }}>
                          {ev.date ? fmtDate(ev.date) : "日時未宁E}{ev.place ? `　${ev.place}` : ""}
                        </div>
                      </div>
                      <div style={{ display: "flex", gap: 6, flexShrink: 0, marginLeft: 10 }}>
                        <span style={S.badge(C.neutralBg, C.textSub)}>参加 {yes}</span>
                        {ev.collecting && (
                          <span style={S.badge(paid === yes && yes > 0 ? C.successBg : C.warnBg,
                            paid === yes && yes > 0 ? C.success : C.warn)}>
                            雁E�� {paid}/{yes}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    /* ── メンバ�E行（幹事用�E�E── */
    function MemberRow({ m, onRemove }) {
      return (
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between",
          padding: "9px 0", borderBottom: `1px solid ${C.border}` }}>
          <span style={{ fontSize: "0.875rem", color: C.text }}>{m.name}</span>
          <button onClick={(e) => { e.stopPropagation(); onRemove(); }}
            style={{ background: "none", border: "none", color: C.textMuted,
              fontSize: "0.75rem", cursor: "pointer", fontFamily: C.font, padding: "3px 6px" }}>削除</button>
        </div>
      );
    }

    /* ── 管琁E��面 ── */
    function Manage({ eventId, go }) {
      const [ev, setEv] = useState(null);
      const [tab, setTab] = useState("rsvp");
      const [showSetup, setShowSetup] = useState(false);
      const amountRef = useRef(null);
      const payUrlRef = useRef(null);

      const load = () => {
        const all = db.get("atsumeru_events") || [];
        setEv(all.find((e) => e.id === eventId) || null);
      };
      useEffect(() => {
        load();
        const onStorage = (e) => { if (e.key === "atsumeru_events") load(); };
        window.addEventListener("storage", onStorage);
        const timer = setInterval(load, 1000);
        return () => { window.removeEventListener("storage", onStorage); clearInterval(timer); };
      }, [eventId]);

      const save = (updated) => {
        const all = db.get("atsumeru_events") || [];
        const idx = all.findIndex((e) => e.id === eventId);
        if (idx >= 0) all[idx] = updated;
        db.set("atsumeru_events", all);
        setEv(updated);
      };

      const startCollecting = () => {
        const amount = Number(amountRef.current?.value);
        const payUrl = payUrlRef.current?.value?.trim() || "";
        if (!amount || amount <= 0) return;
        save({ ...ev, collecting: true, amount, payUrl });
        setShowSetup(false);
      };

      const togglePaid = (memberId) => {
        save({
          ...ev,
          members: ev.members.map((m) =>
            m.id === memberId
              ? { ...m, paid: !m.paid, paidAt: !m.paid ? new Date().toISOString() : null }
              : m
          ),
        });
      };

      const removeMember = (memberId) => {
        save({ ...ev, members: ev.members.filter((m) => m.id !== memberId) });
      };

      if (!ev) return null;

      const shareUrl = (() => {
        const data = { id: ev.id, title: ev.title, date: ev.date, place: ev.place,
          note: ev.note, collecting: ev.collecting, amount: ev.amount, payUrl: ev.payUrl };
        const enc = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
        return `${window.location.origin}${window.location.pathname}?event=${ev.id}&d=${enc}`;
      })();

      const copyLink = () => {
        navigator.clipboard?.writeText(shareUrl).then(() => {
          alert("URLをコピーしました。参加者へ送ってください。\n\n" + shareUrl);
        }).catch(() => { prompt("このURLを参加者へ送ってください。", shareUrl); });
      };

      const yesMembers = ev.members.filter((m) => m.rsvp === "yes");
      const noMembers = ev.members.filter((m) => m.rsvp === "no");
      const maybeMembers = ev.members.filter((m) => m.rsvp === "maybe");
      const paidCount = yesMembers.filter((m) => m.paid).length;

      return (
        <div style={{ ...S.wrap, paddingTop: 20, paddingBottom: 80, ...S.anim }}>
          <button style={{ ...S.btn, ...S.btnGhost, ...S.btnSm, marginBottom: 16 }} onClick={() => go("list")}>戻めE/button>

          <div style={{ ...S.card, marginBottom: 12 }}>
            <h2 style={{ ...S.h2, marginBottom: 4 }}>{ev.title}</h2>
            <p style={{ fontSize: "0.78rem", color: C.textMuted }}>
              {ev.date ? fmtDate(ev.date) : "日時未宁E}{ev.place ? `　${ev.place}` : ""}
            </p>
            {ev.note && <p style={{ fontSize: "0.78rem", color: C.textSub, marginTop: 6 }}>{ev.note}</p>}
            <div style={S.divider} />

            <div style={{ display: "flex", gap: 8, marginBottom: 12 }}>
              <input
                style={{ ...S.input, flex: 1, background: C.surface }}
                type="text"
                readOnly
                value={shareUrl}
                onFocus={(e) => e.target.select()}
              />
              <button style={{ ...S.btn, ...S.btnPrimary, ...S.btnSm }} onClick={copyLink}>コピ�E</button>
            </div>

            <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => setShowSetup(!showSetup)}>
              {ev.collecting ? "雁E��設定を変更" : "雁E��を開姁E}
            </button>

            {showSetup && (
              <div style={{ marginTop: 16, padding: "16px", background: C.bg, borderRadius: C.radius }}>
                <Field label="1人あたり�E金顁E>
                  <input ref={amountRef} style={S.input} type="number" inputMode="numeric" placeholder="4500" defaultValue={ev.amount} />
                </Field>
                <Field label="送E��URL�E�EayPayなど・任意！E hint="入力すると参加老E��送E��ボタンが表示されまぁE>
                  <input ref={payUrlRef} style={S.input} type="url" inputMode="url"
                    autoCapitalize="none" autoCorrect="off" spellCheck={false}
                    placeholder="https://pay.paypay.ne.jp/..." defaultValue={ev.payUrl} />
                </Field>
                <div style={{ display: "flex", gap: 8, marginTop: 4 }}>
                  <button style={{ ...S.btn, ...S.btnGhost, flex: 1 }} onClick={() => setShowSetup(false)}>キャンセル</button>
                  <button style={{ ...S.btn, ...S.btnPrimary, flex: 1 }} onClick={startCollecting}>雁E��を開姁E/button>
                </div>
              </div>
            )}
          </div>

          <div style={{ display: "flex", gap: 10, marginBottom: 16 }}>
            <button onClick={() => setTab("rsvp")} style={{
              ...S.btn, ...S.btnSm,
              background: tab === "rsvp" ? C.primary : C.border,
              color: tab === "rsvp" ? "#fff" : C.text,
            }}>出欠 ({ev.members.length})</button>
            <button onClick={() => setTab("collect")} style={{
              ...S.btn, ...S.btnSm,
              background: tab === "collect" ? C.primary : C.border,
              color: tab === "collect" ? "#fff" : C.text,
            }}>雁E�� ({yesMembers.length})</button>
          </div>

          {tab === "rsvp" && (
            <div>
              {yesMembers.length > 0 && (
                <div style={{ marginBottom: 20 }}>
                  <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.success, marginBottom: 8 }}>参加 ({yesMembers.length})</p>
                  {yesMembers.map((m) => <MemberRow key={m.id} m={m} onRemove={() => removeMember(m.id)} />)}
                </div>
              )}
              {maybeMembers.length > 0 && (
                <div style={{ marginBottom: 20 }}>
                  <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.warn, marginBottom: 8 }}>未宁E({maybeMembers.length})</p>
                  {maybeMembers.map((m) => <MemberRow key={m.id} m={m} onRemove={() => removeMember(m.id)} />)}
                </div>
              )}
              {noMembers.length > 0 && (
                <div>
                  <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.danger, marginBottom: 8 }}>不参加 ({noMembers.length})</p>
                  {noMembers.map((m) => <MemberRow key={m.id} m={m} onRemove={() => removeMember(m.id)} />)}
                </div>
              )}
            </div>
          )}

          {tab === "collect" && (
            <div>
              {!ev.collecting && (
                <div style={{ marginBottom: 12, padding: "12px", background: C.neutralBg, borderRadius: C.radius }}>
                  <p style={{ fontSize: "0.78rem", color: C.textMuted }}>雁E��を開始するとチェチE��できまぁE/p>
                </div>
              )}
              {ev.collecting && (
                <>
                  <div style={{ marginBottom: 16, padding: "12px", background: C.neutralBg, borderRadius: C.radius, textAlign: "center" }}>
                    <p style={{ fontSize: "0.7rem", color: C.textMuted }}>雁E��状況E/p>
                    <p style={{ fontSize: "1.2rem", fontWeight: 700, color: C.text, marginTop: 4 }}>{paidCount} / {yesMembers.length}</p>
                  </div>
                  {yesMembers.map((m) => (
                    <div key={m.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 0", borderBottom: `1px solid ${C.border}` }}>
                      <span style={{ fontSize: "0.875rem", color: C.text }}>{m.name}</span>
                      <button onClick={() => togglePaid(m.id)} style={{
                        ...S.btn, ...S.btnSm,
                        background: m.paid ? C.success : C.border, color: m.paid ? "#fff" : C.text,
                      }}>{m.paid ? "渁E : "未"}</button>
                    </div>
                  ))}
                </>
              )}
            </div>
          )}
        </div>
      );
    }
    function ParticipantPage({ eventId }) {
      const [ev, setEv] = useState(null);
      const [step, setStep] = useState("rsvp");
      const [myName, setMyName] = useState("");
      const nameRef = useRef(null);
      const hydratedFromUrl = useRef(false);

      const getCurrentEvent = () => {
        const all = db.get("atsumeru_events") || [];
        return all.find((e) => e.id === eventId) || null;
      };

      const seedFromUrl = () => {
        const enc = new URLSearchParams(window.location.search).get("d");
        if (!enc) return null;
        try {
          const data = JSON.parse(decodeURIComponent(escape(atob(enc))));
          if (!data || data.id !== eventId) return null;
          const all = db.get("atsumeru_events") || [];
          if (!all.find((e) => e.id === eventId)) {
            all.push({ ...data, members: [] });
            db.set("atsumeru_events", all);
          }
          return (db.get("atsumeru_events") || []).find((e) => e.id === eventId) || null;
        } catch { return null; }
      };

      const writeNameToUrl = (name) => {
        const u = new URL(window.location.href);
        u.searchParams.set("event", eventId);
        u.searchParams.set("name", name);
        window.history.replaceState({}, "", u.toString());
      };

      const load = () => setEv(getCurrentEvent() || seedFromUrl());

      useEffect(() => {
        load();
        const onStorage = (e) => { if (e.key === "atsumeru_events") load(); };
        window.addEventListener("storage", onStorage);
        const timer = setInterval(load, 1000);
        return () => { window.removeEventListener("storage", onStorage); clearInterval(timer); };
      }, [eventId]);

      useEffect(() => {
        if (step !== "paying") return;
        const h = () => { if (document.visibilityState === "visible") setStep("confirm"); };
        const f = () => setStep("confirm");
        document.addEventListener("visibilitychange", h);
        window.addEventListener("focus", f);
        return () => { document.removeEventListener("visibilitychange", h); window.removeEventListener("focus", f); };
      }, [step]);

      useEffect(() => {
        if (hydratedFromUrl.current || !ev) return;
        const n = (new URLSearchParams(window.location.search).get("name") || "").trim();
        hydratedFromUrl.current = true;
        if (!n) return;
        const member = ev.members.find((m) => m.name === n);
        if (!member) return;
        setMyName(n);
        if (ev.collecting && member.rsvp === "yes") setStep("rsvp_done");
      }, [ev]);

      const submitRsvp = (rsvp) => {
        const name = nameRef.current?.value?.trim();
        if (!name) { alert("名前を�E力してください"); return; }
        const all = db.get("atsumeru_events") || [];
        const updated = all.map((e) => {
          if (e.id !== eventId) return e;
          const existing = e.members.find((m) => m.name === name);
          if (existing) return { ...e, members: e.members.map((m) => m.name === name ? { ...m, rsvp } : m) };
          return { ...e, members: [...e.members, { id: genId(), name, rsvp, paid: false, paidAt: null }] };
        });
        db.set("atsumeru_events", updated);
        const nextEv = updated.find((e) => e.id === eventId) || null;
        if (!nextEv) { alert("イベントが見つかりません"); return; }
        setEv(nextEv);
        writeNameToUrl(name);
        if (rsvp === "yes" && nextEv.collecting) { startPaymentFlow(name); return; }
        setMyName(name);
        setStep("rsvp_done");
      };

      const startPaymentFlow = (name) => {
        const current = getCurrentEvent();
        if (!current) return;
        const member = current.members.find((m) => m.name === name);
        if (!member || member.rsvp !== "yes") { alert("参加惁E��が見つかりません"); return; }
        if (member.paid) { setMyName(name); setEv(current); setStep("rsvp_done"); return; }
        writeNameToUrl(name);
        setMyName(name);
        setEv(current);
        if (current.payUrl) {
          setStep("paying");
          setTimeout(() => { window.open(current.payUrl, "_blank"); }, 100);
        } else {
          setStep("confirm");
        }
      };

      const openPayLink = () => {
        if (!myName) return;
        startPaymentFlow(myName);
      };

      const confirmPaid = () => {
        const all = db.get("atsumeru_events") || [];
        const updated = all.map((e) => {
          if (e.id !== eventId) return e;
          return { ...e, members: e.members.map((m) =>
            m.name === myName ? { ...m, paid: true, paidAt: new Date().toISOString() } : m
          )};
        });
        db.set("atsumeru_events", updated);
        setStep("done");
      };

      const handlePayLaterBySelection = (name) => {
        if (!name) return;
        const member = (ev?.members || []).find((m) => m.name === name);
        if (!member || member.rsvp !== "yes" || member.paid) return;
        writeNameToUrl(name);
        startPaymentFlow(name);
      };

      const Header = () => (
        <div style={{ borderBottom: `1px solid ${C.border}`, background: C.surface, marginBottom: 24 }}>
          <div style={{ ...S.wrap, height: 52, display: "flex", alignItems: "center" }}>
            <span style={{ fontSize: "0.9rem", fontWeight: 700, color: C.primary }}>アチE��ル</span>
          </div>
        </div>
      );

      if (!ev) return (
        <>
          <Header />
          <div style={{ ...S.wrap, textAlign: "center", paddingTop: 48 }}>
            <div style={S.cardLg}>
              <p style={{ color: C.textSub }}>イベントが見つかりません</p>
            </div>
          </div>
        </>
      );

      if (step === "done") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingTop: 24, ...S.anim }}>
            <div style={{ ...S.cardLg, textAlign: "center", padding: "44px 24px", borderColor: C.success }}>
              <div style={{ fontSize: "0.75rem", fontWeight: 700, color: C.success, letterSpacing: "0.06em", marginBottom: 12 }}>完亁E/div>
              <h2 style={{ ...S.h2, marginBottom: 8 }}>支払いを報告しました</h2>
              <p style={S.sub}>幹事に反映されました。ありがとぁE��ざいます、E/p>
            </div>
          </div>
        </>
      );

      if (step === "confirm") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingTop: 24, ...S.anim }}>
            <div style={{ ...S.cardLg, textAlign: "center" }}>
              <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.textMuted, letterSpacing: "0.06em", marginBottom: 12 }}>確誁E/p>
              <h2 style={{ ...S.h2, marginBottom: 8 }}>送E��は完亁E��ましたか！E/h2>
              <p style={{ ...S.sub, marginBottom: 28 }}>{myName}さんの支払いを記録しまぁE/p>
              <button style={{ ...S.btn, ...S.btnSuccess, marginBottom: 10 }} onClick={confirmPaid}>はぁE��E��E��しました</button>
              <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => setStep("rsvp_done")}>まだしてぁE��ぁE/button>
            </div>
          </div>
        </>
      );

      if (step === "paying") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingTop: 24, textAlign: "center", ...S.anim }}>
            <div style={S.cardLg}>
              <div style={{ width: 36, height: 36, borderRadius: "50%", border: `2px solid ${C.border}`, borderTopColor: C.primary, animation: "spin 0.9s linear infinite", margin: "0 auto 20px" }} />
              <h2 style={{ ...S.h2, marginBottom: 8 }}>送E��アプリを開ぁE��ぁE��ぁE/h2>
              <p style={{ ...S.sub, marginBottom: 24 }}>送E��が終わったらこ�Eペ�Eジに戻ってください</p>
              <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => setStep("confirm")}>送E��が終わっぁE/button>
            </div>
          </div>
        </>
      );

      const yesMembers = ev.members.filter((m) => m.rsvp === "yes");
      const myMember = myName ? ev.members.find((m) => m.name === myName) : null;

      if (step === "rsvp_done") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingBottom: 60, ...S.anim }}>
            <div style={S.cardLg}>
              <div style={{ textAlign: "center", marginBottom: 20 }}>
                <div style={{ display: "inline-flex", alignItems: "center", justifyContent: "center", width: 40, height: 40, borderRadius: "50%", background: C.successBg, color: C.success, fontSize: "1rem", marginBottom: 12 }}>✁E/div>
                <h2 style={{ ...S.h2, marginBottom: 4 }}>回答しました</h2>
                <p style={{ fontSize: "0.8rem", color: C.textMuted }}>{myName}さん �E�E{myMember?.rsvp === "yes" ? "参加" : myMember?.rsvp === "no" ? "不参加" : "未宁E}</p>
              </div>

              {ev.collecting && myMember?.rsvp === "yes" && !myMember?.paid && (
                <div style={{ background: C.bg, borderRadius: C.radius, padding: 18, marginBottom: 4 }}>
                  <div style={{ textAlign: "center", marginBottom: 14 }}>
                    <div style={{ fontSize: "1.5rem", fontWeight: 700, color: C.text, letterSpacing: "-0.02em" }}>¥{ev.amount.toLocaleString()}</div>
                    <p style={{ fontSize: "0.72rem", color: C.textMuted, marginTop: 2 }}>お支払い金顁E/p>
                  </div>
                  {ev.payUrl
                    ? <button style={{ ...S.btn, background: "#E00020", color: "#fff" }} onClick={openPayLink}>PayPayで送E��する</button>
                    : <button style={{ ...S.btn, ...S.btnPrimary }} onClick={() => setStep("confirm")}>送E��したので報告すめE/button>
                  }
                </div>
              )}

              {ev.collecting && myMember?.paid && (
                <div style={{ background: C.successBg, borderRadius: C.radius, padding: 16, textAlign: "center", marginBottom: 4 }}>
                  <span style={{ fontSize: "0.875rem", fontWeight: 600, color: C.success }}>支払い済みでぁE/span>
                </div>
              )}

              {yesMembers.length > 0 && (
                <div style={{ marginTop: 20, borderTop: `1px solid ${C.border}`, paddingTop: 16 }}>
                  <p style={{ fontSize: "0.72rem", fontWeight: 700, color: C.textMuted, marginBottom: 8, letterSpacing: "0.03em" }}>参加老E��{yesMembers.length}吁E/p>
                  {yesMembers.map((m) => (
                    <div key={m.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "6px 0" }}>
                      <span style={{ fontSize: "0.85rem", color: C.text }}>{m.name}</span>
                      {ev.collecting && (
                        <span style={S.badge(m.paid ? C.successBg : C.warnBg, m.paid ? C.success : C.warn)}>
                          {m.paid ? "渁E : "未"}
                        </span>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </>
      );

      return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingBottom: 60, ...S.anim }}>
            <div style={S.cardLg}>
              <h2 style={{ ...S.h2, marginBottom: 4 }}>{ev.title}</h2>
              <p style={{ fontSize: "0.78rem", color: C.textMuted, marginBottom: 2 }}>{ev.date ? fmtDate(ev.date) : "日時未宁E}{ev.place ? `　${ev.place}` : ""}</p>
              {ev.note && <p style={{ fontSize: "0.78rem", color: C.textSub, marginTop: 4 }}>{ev.note}</p>}

              <div style={S.divider} />

              {/* 出欠を回答すめE*/}
              <p style={{ fontWeight: 600, fontSize: "0.875rem", marginBottom: 14, color: C.text }}>出欠を回答すめE/p>
              <Field label="名前">
                <input ref={nameRef} style={S.input} type="text" placeholder="お名剁E defaultValue="" />
              </Field>
              <div className="rsvp-actions">
                <button style={{ ...S.btn, ...S.btnSuccess, flex: 1 }} onClick={() => submitRsvp("yes")}>参加</button>
                <button style={{ ...S.btn, ...S.btnWarn,   flex: 1 }} onClick={() => submitRsvp("maybe")}>未宁E/button>
                <button style={{ ...S.btn, ...S.btnDanger, flex: 1 }} onClick={() => submitRsvp("no")}>不参加</button>
              </div>

              {/* あとから支払う */}
              {ev.collecting && (() => {
                const unpaid = ev.members.filter((m) => m.rsvp === "yes" && !m.paid);
                if (unpaid.length === 0) return null;
                return (
                  <div style={{ marginTop: 20, padding: "16px", background: C.bg, borderRadius: C.radius, border: `1px solid ${C.border}` }}>
                    <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.textSub, marginBottom: 2 }}>あとから支払う</p>
                    <p style={{ fontSize: "0.72rem", color: C.textMuted, marginBottom: 12 }}>自刁E�E名前を選んでください</p>
                    <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                      {unpaid.map((m) => (
                        <button key={m.id} onClick={() => handlePayLaterBySelection(m.name)} style={{
                          display: "flex", alignItems: "center", gap: 10,
                          padding: "10px 12px", borderRadius: C.radiusSm,
                          border: `1.5px solid ${C.border}`,
                          background: C.surface,
                          cursor: "pointer", fontFamily: C.font, width: "100%", textAlign: "left",
                          transition: "all 0.12s",
                        }}>
                          <div style={{ width: 18, height: 18, borderRadius: "50%", flexShrink: 0, border: `2px solid ${C.borderDark}`, background: "transparent", display: "flex", alignItems: "center", justifyContent: "center", transition: "all 0.12s" }}>
                            <div style={{ width: 6, height: 6, borderRadius: "50%", background: C.borderDark }} />
                          </div>
                          <span style={{ fontSize: "0.875rem", color: C.text, fontWeight: 500 }}>{m.name}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                );
              })()}

              {ev.members.length > 0 && (
                <div style={{ marginTop: 24, borderTop: `1px solid ${C.border}`, paddingTop: 16 }}>
                  <p style={{ fontSize: "0.72rem", fontWeight: 700, color: C.textMuted, marginBottom: 8, letterSpacing: "0.03em" }}>回答状況　{ev.members.length}吁E/p>
                  {ev.members.map((m) => (
                    <div key={m.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "6px 0" }}>
                      <span style={{ fontSize: "0.85rem", color: C.text }}>{m.name}</span>
                      <span style={S.badge(
                        m.rsvp === "yes" ? C.successBg : m.rsvp === "no" ? C.dangerBg : C.warnBg,
                        m.rsvp === "yes" ? C.success : m.rsvp === "no" ? C.danger : C.warn,
                      )}>{m.rsvp === "yes" ? "参加" : m.rsvp === "no" ? "不参加" : "未宁E}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </>
      );
    }
    function App() {
      const [page, setPage]     = useState("home");
      const [pageArg, setPageArg] = useState(null);
      const [user, setUser]     = useState(null);

      const go = (p, arg) => { setPage(p); setPageArg(arg || null); };

      useEffect(() => {
        const saved = db.get("atsumeru_user");
        if (saved) setUser(saved);
        const params = new URLSearchParams(window.location.search);
        const eid = params.get("event");
        if (eid) { setPage("participant"); setPageArg(eid); }
      }, []);

      const logout = () => { setUser(null); db.set("atsumeru_user", null); go("home"); };

      return (
        <div style={{ fontFamily: C.font, background: C.bg, color: C.text,
          minHeight: "100vh", lineHeight: 1.6, WebkitFontSmoothing: "antialiased" }}>
          {page !== "participant" && <Nav goHome={() => go("home")} user={user} logout={logout} />}
          {page === "participant" && <ParticipantPage eventId={pageArg} />}
          {page === "home"        && <Home go={go} user={user} />}
          {page === "login"       && <Login go={go} setUser={setUser} />}
          {page === "create"      && <Create go={go} user={user} />}
          {page === "list"        && <EventList go={go} user={user} />}
          {page === "manage"      && <Manage eventId={pageArg} go={go} />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>

