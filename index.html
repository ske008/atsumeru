<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>繧｢繝・Γ繝ｫ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { font-size: 16px; }
    body { background: #F5F4F1; -webkit-font-smoothing: antialiased; min-height: 100vh; padding-bottom: env(safe-area-inset-bottom); }
    input, button, select, textarea { font-size: 16px !important; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    input:focus { border-color: #2D5A3D !important; background: #fff !important; }
    button:hover { opacity: 0.88; }
    button:active { opacity: 0.72; transform: scale(0.98); }
    .rsvp-actions { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; }
    @media (max-width: 420px) { .rsvp-actions { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div style='padding:8px 12px;background:#e6f5ee;border-bottom:1px solid #b7e1cb;font-family:sans-serif;font-size:14px;'>新版はこちら: <a href='/' style='color:#0b4f32;font-weight:700;'>Next版を開く</a></div>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const genId = () => Math.random().toString(36).slice(2, 10);
    const fmtDate = (d) => new Date(d).toLocaleDateString("ja-JP", { year: "numeric", month: "long", day: "numeric" });

    const db = {
      get: (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    };

    /* 笏笏 繝・じ繧､繝ｳ繝医・繧ｯ繝ｳ 笏笏 */
    const C = {
      bg:          "#F5F4F1",
      surface:     "#FFFFFF",
      border:      "#E2E0DB",
      borderDark:  "#C8C6BF",
      text:        "#1C1C1A",
      textSub:     "#6B6B67",
      textMuted:   "#A0A09C",

      primary:     "#2D5A3D",   /* 豺ｱ邱・*/
      primaryBg:   "#EEF4F0",
      primaryText: "#1A3D28",

      danger:      "#B91C1C",
      dangerBg:    "#FEF2F2",

      warn:        "#92400E",
      warnBg:      "#FFFBEB",

      success:     "#166534",
      successBg:   "#F0FDF4",

      neutral:     "#374151",
      neutralBg:   "#F9FAFB",

      font: "'Inter', 'Noto Sans JP', sans-serif",
      radius: "8px",
      radiusSm: "6px",
      radiusLg: "12px",
    };

    /* 笏笏 蜈ｱ騾壹せ繧ｿ繧､繝ｫ 笏笏 */
    const S = {
      wrap:    {
        maxWidth: 480, margin: "0 auto", width: "100%",
        paddingLeft: "max(16px, env(safe-area-inset-left))",
        paddingRight: "max(16px, env(safe-area-inset-right))"
      },
      card:    { background: C.surface, borderRadius: C.radiusLg, border: `1px solid ${C.border}`, padding: "20px" },
      cardLg:  { background: C.surface, borderRadius: C.radiusLg, border: `1px solid ${C.border}`, padding: "28px 24px" },

      /* 繝懊ち繝ｳ */
      btn:    { display: "inline-flex", alignItems: "center", justifyContent: "center", gap: 6,
                padding: "11px 20px", borderRadius: C.radius, fontSize: "0.875rem", fontWeight: 600,
                border: "none", cursor: "pointer", fontFamily: C.font, width: "100%",
                transition: "opacity 0.12s", letterSpacing: "0.01em" },
      btnPrimary: { background: C.primary, color: "#fff" },
      btnGhost:   { background: "transparent", color: C.text, border: `1px solid ${C.border}` },
      btnSuccess: { background: C.success, color: "#fff" },
      btnDanger:  { background: C.danger, color: "#fff" },
      btnWarn:    { background: "#D97706", color: "#fff" },
      btnSm:      { padding: "7px 14px", fontSize: "0.8rem", width: "auto" },

      /* 繝輔か繝ｼ繝 */
      input:  { width: "100%", padding: "10px 12px", borderRadius: C.radiusSm,
                border: `1px solid ${C.border}`, fontSize: "0.9rem",
                fontFamily: C.font, background: C.bg, outline: "none",
                boxSizing: "border-box", transition: "border-color 0.12s, background 0.12s",
                color: C.text },
      label:  { display: "block", fontSize: "0.75rem", fontWeight: 600,
                color: C.textSub, marginBottom: 5, letterSpacing: "0.03em" },

      /* 繝・く繧ｹ繝・*/
      h1: { fontSize: "1.65rem", fontWeight: 700, letterSpacing: "-0.02em", lineHeight: 1.25, color: C.text },
      h2: { fontSize: "1.05rem", fontWeight: 700, letterSpacing: "-0.01em", color: C.text },
      sub: { fontSize: "0.83rem", color: C.textSub, lineHeight: 1.65 },

      /* 繝舌ャ繧ｸ */
      badge: (bg, color) => ({
        display: "inline-flex", alignItems: "center", padding: "2px 10px",
        borderRadius: 100, fontSize: "0.7rem", fontWeight: 600,
        background: bg, color, letterSpacing: "0.01em",
      }),

      divider: { height: 1, background: C.border, margin: "20px 0" },
      anim: { animation: "fadeIn 0.18s ease" },
    };

    const Field = ({ label, children, hint }) => (
      <div style={{ marginBottom: 16 }}>
        <label style={S.label}>{label}</label>
        {children}
        {hint && <p style={{ fontSize: "0.72rem", color: C.textMuted, marginTop: 4 }}>{hint}</p>}
      </div>
    );

    /* 笏笏 繝翫ン繧ｲ繝ｼ繧ｷ繝ｧ繝ｳ 笏笏 */
    function Nav({ goHome, user, logout }) {
      return (
        <div style={{ borderBottom: `1px solid ${C.border}`, background: C.surface }}>
          <div style={{ ...S.wrap, display: "flex", alignItems: "center", justifyContent: "space-between", height: 52 }}>
            <button onClick={goHome} style={{ fontSize: "0.95rem", fontWeight: 700, color: C.primary,
              background: "none", border: "none", fontFamily: C.font, cursor: "pointer", letterSpacing: "-0.01em" }}>
              繧｢繝・Γ繝ｫ
            </button>
            {user && (
              <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                <span style={{ fontSize: "0.72rem", color: C.textMuted }}>{user}</span>
                <button onClick={logout} style={{ ...S.btn, ...S.btnGhost, ...S.btnSm }}>繝ｭ繧ｰ繧｢繧ｦ繝・/button>
              </div>
            )}
          </div>
        </div>
      );
    }

    /* 笏笏 繝帙・繝 笏笏 */
    function Home({ go, user }) {
      return (
        <div style={{ ...S.wrap, paddingTop: 48, paddingBottom: 80, ...S.anim }}>
          <div style={{ marginBottom: 40 }}>
            <h1 style={{ ...S.h1, marginBottom: 12 }}>
              蜃ｺ谺繧る寔驥代ｂ縲・br />縺薙ｌ縺ｲ縺ｨ縺､縺ｧ縲・
            </h1>
            <p style={{ ...S.sub, maxWidth: 300 }}>
              繧､繝吶Φ繝医ｒ菴懊▲縺ｦURL繧貞・譛峨☆繧九□縺代・br />蜃ｺ谺遒ｺ隱阪°繧蛾寔驥代∪縺ｧ荳諡ｬ邂｡逅・〒縺阪∪縺吶・
            </p>
          </div>

          <div style={{ display: "flex", flexDirection: "column", gap: 10, maxWidth: 300, marginBottom: 52 }}>
            <button style={{ ...S.btn, ...S.btnPrimary }} onClick={() => go(user ? "create" : "login")}>
              繧､繝吶Φ繝医ｒ縺､縺上ｋ
            </button>
            <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => go(user ? "list" : "login")}>
              繝槭う繧､繝吶Φ繝・
            </button>
          </div>

          <div>
            <p style={{ fontSize: "0.7rem", fontWeight: 700, color: C.textMuted, marginBottom: 14,
              letterSpacing: "0.08em", textTransform: "uppercase" }}>菴ｿ縺・婿</p>
            {[
              { step: "1", t: "繧､繝吶Φ繝医ｒ菴懈・", d: "繧ｿ繧､繝医Ν縺ｨ譌･譎ゅ□縺代〒OK" },
              { step: "2", t: "URL繧貞・譛・, d: "蜿ょ刈閠・′縺昴・縺ｾ縺ｾ蜃ｺ谺蝗樒ｭ・ },
              { step: "3", t: "髮・≡繧堤ｮ｡逅・, d: "謾ｯ謇輔＞迥ｶ豕√ｒ縺ｲ縺ｨ繧√〒遒ｺ隱・ },
            ].map((x) => (
              <div key={x.step} style={{ display: "flex", alignItems: "flex-start", gap: 14,
                padding: "14px 0", borderBottom: `1px solid ${C.border}` }}>
                <span style={{ minWidth: 22, height: 22, borderRadius: "50%", background: C.primaryBg,
                  color: C.primary, fontSize: "0.72rem", fontWeight: 700,
                  display: "flex", alignItems: "center", justifyContent: "center", marginTop: 1 }}>{x.step}</span>
                <div>
                  <div style={{ fontWeight: 600, fontSize: "0.875rem", color: C.text }}>{x.t}</div>
                  <div style={{ fontSize: "0.78rem", color: C.textSub, marginTop: 2 }}>{x.d}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* 笏笏 繝ｭ繧ｰ繧､繝ｳ 笏笏 */
    function Login({ go, setUser }) {
      const ref = useRef(null);
      const [ok, setOk] = useState(false);
      const [err, setErr] = useState(false);
      const handle = () => {
        const v = ref.current?.value || "";
        if (!v.includes("@")) { setErr(true); return; }
        setErr(false);
        db.set("atsumeru_user", v);
        setUser(v);
        setOk(true);
        setTimeout(() => go("list"), 700);
      };
      return (
        <div style={{ ...S.wrap, paddingTop: 48, ...S.anim }}>
          <div style={S.cardLg}>
            <h2 style={{ ...S.h2, marginBottom: 4 }}>繝ｭ繧ｰ繧､繝ｳ</h2>
            <p style={{ ...S.sub, marginBottom: 24 }}>繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ縺縺代〒蛻ｩ逕ｨ縺ｧ縺阪∪縺・/p>
            {ok ? (
              <div style={{ textAlign: "center", padding: "24px 0", background: C.successBg,
                borderRadius: C.radius, color: C.success, fontWeight: 600 }}>
                繝ｭ繧ｰ繧､繝ｳ縺励∪縺励◆
              </div>
            ) : (
              <>
                <Field label="繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ">
                  <input ref={ref} style={{ ...S.input, borderColor: err ? C.danger : C.border }}
                    type="email" inputMode="email" autoCapitalize="none"
                    autoCorrect="off" spellCheck={false} placeholder="you@example.com" defaultValue=""
                    onKeyDown={(e) => e.key === "Enter" && handle()} />
                  {err && <p style={{ fontSize: "0.72rem", color: C.danger, marginTop: 4 }}>豁｣縺励＞繝｡繝ｼ繝ｫ繧｢繝峨Ξ繧ｹ繧貞・蜉帙＠縺ｦ縺上□縺輔＞</p>}
                </Field>
                <button style={{ ...S.btn, ...S.btnPrimary }} onClick={handle}>繝ｭ繧ｰ繧､繝ｳ</button>
              </>
            )}
          </div>
        </div>
      );
    }

    /* 笏笏 繧､繝吶Φ繝井ｽ懈・ 笏笏 */
    function Create({ go, user }) {
      const titleRef = useRef(null);
      const dateRef   = useRef(null);
      const placeRef  = useRef(null);
      const noteRef   = useRef(null);
      const [err, setErr] = useState(false);

      const handle = () => {
        const title = titleRef.current?.value?.trim();
        if (!title) { setErr(true); return; }
        setErr(false);
        const ev = {
          id: genId(), title,
          date:  dateRef.current?.value  || "",
          place: placeRef.current?.value || "",
          note:  noteRef.current?.value  || "",
          createdBy: user, createdAt: new Date().toISOString(),
          members: [], collecting: false, amount: 0, payUrl: "",
        };
        const all = db.get("atsumeru_events") || [];
        all.push(ev);
        db.set("atsumeru_events", all);
        go("manage", ev.id);
      };

      return (
        <div style={{ ...S.wrap, paddingTop: 28, paddingBottom: 80, ...S.anim }}>
          <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 20 }}>
            <button style={{ ...S.btn, ...S.btnGhost, ...S.btnSm }} onClick={() => go("list")}>竊・謌ｻ繧・/button>
            <h2 style={S.h2}>繧､繝吶Φ繝医ｒ菴懈・</h2>
          </div>
          <div style={S.cardLg}>
            <Field label="繧､繝吶Φ繝亥錐 *">
              <input ref={titleRef} style={{ ...S.input, borderColor: err ? C.danger : C.border }}
                type="text" placeholder="萓具ｼ・譛医・鬟ｲ縺ｿ莨・ defaultValue=""
                onKeyDown={(e) => e.key === "Enter" && handle()} />
              {err && <p style={{ fontSize: "0.72rem", color: C.danger, marginTop: 4 }}>繧､繝吶Φ繝亥錐繧貞・蜉帙＠縺ｦ縺上□縺輔＞</p>}
            </Field>
            <Field label="譌･譎ゑｼ井ｻｻ諢擾ｼ・>
              <input ref={dateRef} style={S.input} type="datetime-local" defaultValue="" />
            </Field>
            <Field label="蝣ｴ謇・井ｻｻ諢擾ｼ・>
              <input ref={placeRef} style={S.input} type="text" placeholder="萓具ｼ壽ｸ玖ｰｷ縺ｮ螻・・螻・ defaultValue="" />
            </Field>
            <Field label="繝｡繝｢・井ｻｻ諢擾ｼ・>
              <input ref={noteRef} style={S.input} type="text" placeholder="萓具ｼ夐≦蛻ｻ縺吶ｋ蝣ｴ蜷医・騾｣邨｡繧・ defaultValue="" />
            </Field>
            <button style={{ ...S.btn, ...S.btnPrimary, marginTop: 4 }} onClick={handle}>菴懈・縺吶ｋ</button>
          </div>
        </div>
      );
    }

    /* 笏笏 繧､繝吶Φ繝井ｸ隕ｧ 笏笏 */
    function EventList({ go, user }) {
      const events = (db.get("atsumeru_events") || []).filter((e) => e.createdBy === user);
      return (
        <div style={{ ...S.wrap, paddingTop: 28, paddingBottom: 80, ...S.anim }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 20 }}>
            <h2 style={S.h2}>繝槭う繧､繝吶Φ繝・/h2>
            <button style={{ ...S.btn, ...S.btnPrimary, ...S.btnSm }} onClick={() => go("create")}>+ 譁ｰ隕丈ｽ懈・</button>
          </div>

          {events.length === 0 ? (
            <div style={{ ...S.cardLg, textAlign: "center", padding: "48px 24px" }}>
              <p style={{ color: C.textMuted, marginBottom: 20, fontSize: "0.875rem" }}>
                縺ｾ縺繧､繝吶Φ繝医′縺ゅｊ縺ｾ縺帙ｓ
              </p>
              <button style={{ ...S.btn, ...S.btnPrimary }} onClick={() => go("create")}>
                譛蛻昴・繧､繝吶Φ繝医ｒ菴懈・
              </button>
            </div>
          ) : (
            <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
              {events.map((ev) => {
                const yes  = ev.members.filter((m) => m.rsvp === "yes").length;
                const paid = ev.members.filter((m) => m.paid).length;
                return (
                  <div key={ev.id} style={{ ...S.card, cursor: "pointer" }} onClick={() => go("manage", ev.id)}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontWeight: 600, fontSize: "0.9rem", marginBottom: 3,
                          whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{ev.title}</div>
                        <div style={{ fontSize: "0.75rem", color: C.textMuted }}>
                          {ev.date ? fmtDate(ev.date) : "譌･譎よ悴螳・}{ev.place ? `縲${ev.place}` : ""}
                        </div>
                      </div>
                      <div style={{ display: "flex", gap: 6, flexShrink: 0, marginLeft: 10 }}>
                        <span style={S.badge(C.neutralBg, C.textSub)}>蜿ょ刈 {yes}</span>
                        {ev.collecting && (
                          <span style={S.badge(paid === yes && yes > 0 ? C.successBg : C.warnBg,
                            paid === yes && yes > 0 ? C.success : C.warn)}>
                            髮・≡ {paid}/{yes}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    }

    /* 笏笏 繝｡繝ｳ繝舌・陦鯉ｼ亥ｹｹ莠狗畑・・笏笏 */
    function MemberRow({ m, onRemove }) {
      return (
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between",
          padding: "9px 0", borderBottom: `1px solid ${C.border}` }}>
          <span style={{ fontSize: "0.875rem", color: C.text }}>{m.name}</span>
          <button onClick={(e) => { e.stopPropagation(); onRemove(); }}
            style={{ background: "none", border: "none", color: C.textMuted,
              fontSize: "0.75rem", cursor: "pointer", fontFamily: C.font, padding: "3px 6px" }}>蜑企勁</button>
        </div>
      );
    }

    /* 笏笏 邂｡逅・判髱｢ 笏笏 */
    function Manage({ eventId, go }) {
      const [ev, setEv] = useState(null);
      const [tab, setTab] = useState("rsvp");
      const [showSetup, setShowSetup] = useState(false);
      const amountRef = useRef(null);
      const payUrlRef = useRef(null);

      const load = () => {
        const all = db.get("atsumeru_events") || [];
        setEv(all.find((e) => e.id === eventId) || null);
      };
      useEffect(() => {
        load();
        const onStorage = (e) => { if (e.key === "atsumeru_events") load(); };
        window.addEventListener("storage", onStorage);
        const timer = setInterval(load, 1000);
        return () => { window.removeEventListener("storage", onStorage); clearInterval(timer); };
      }, [eventId]);

      const save = (updated) => {
        const all = db.get("atsumeru_events") || [];
        const idx = all.findIndex((e) => e.id === eventId);
        if (idx >= 0) all[idx] = updated;
        db.set("atsumeru_events", all);
        setEv(updated);
      };

      const shareUrl = `${window.location.origin}${window.location.pathname}?event=${eventId}`;

      const copyLink = () => {
        navigator.clipboard?.writeText(shareUrl).then(() => {
          alert("URL繧偵さ繝斐・縺励∪縺励◆縲ょ盾蜉閠・↓騾√▲縺ｦ縺上□縺輔＞縲・n\n" + shareUrl);
        }).catch(() => { prompt("縺薙・URL繧貞盾蜉閠・↓騾√▲縺ｦ縺上□縺輔＞・・, shareUrl); });
      };
const startCollecting = () => {
        const amount = Number(amountRef.current?.value);
        const payUrl = payUrlRef.current?.value?.trim() || "";
        if (!amount || amount <= 0) return;
        save({ ...ev, collecting: true, amount, payUrl });
        setShowSetup(false);
      };

      const togglePaid = (memberId) => {
        save({
          ...ev,
          members: ev.members.map((m) =>
            m.id === memberId
              ? { ...m, paid: !m.paid, paidAt: !m.paid ? new Date().toISOString() : null }
              : m
          ),
        });
      };

      const removeMember = (memberId) => {
        save({ ...ev, members: ev.members.filter((m) => m.id !== memberId) });
      };

      if (!ev) return null;

      const yesMembers = ev.members.filter((m) => m.rsvp === "yes");
      const noMembers = ev.members.filter((m) => m.rsvp === "no");
      const maybeMembers = ev.members.filter((m) => m.rsvp === "maybe");
      const paidCount = yesMembers.filter((m) => m.paid).length;

      return (
        <div style={{ ...S.wrap, paddingTop: 20, paddingBottom: 80, ...S.anim }}>
          <button style={{ ...S.btn, ...S.btnGhost, ...S.btnSm, marginBottom: 16 }} onClick={() => go("list")}>謌ｻ繧・/button>

          <div style={{ ...S.card, marginBottom: 12 }}>
            <h2 style={{ ...S.h2, marginBottom: 4 }}>{ev.title}</h2>
            <p style={{ fontSize: "0.78rem", color: C.textMuted }}>
              {ev.date ? fmtDate(ev.date) : "譌･譎よ悴螳・}{ev.place ? `縲${ev.place}` : ""}
            </p>
            {ev.note && <p style={{ fontSize: "0.78rem", color: C.textSub, marginTop: 6 }}>{ev.note}</p>}
            <div style={S.divider} />

            <div style={{ display: "flex", gap: 8, marginBottom: 12 }}>
              <input
                style={{ ...S.input, flex: 1, background: C.surface }}
                type="text"
                readOnly
                value={shareUrl}
                onFocus={(e) => e.target.select()}
              />
              <button style={{ ...S.btn, ...S.btnPrimary, ...S.btnSm }} onClick={copyLink}>繧ｳ繝斐・</button>
            </div>

            <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => setShowSetup(!showSetup)}>
              {ev.collecting ? "髮・≡險ｭ螳壹ｒ螟画峩" : "髮・≡繧帝幕蟋・}
            </button>

            {showSetup && (
              <div style={{ marginTop: 16, padding: "16px", background: C.bg, borderRadius: C.radius }}>
                <Field label="1莠ｺ縺ゅ◆繧翫・驥鷹｡・>
                  <input ref={amountRef} style={S.input} type="number" inputMode="numeric" placeholder="4500" defaultValue={ev.amount} />
                </Field>
                <Field label="騾・≡URL・・ayPay縺ｪ縺ｩ繝ｻ莉ｻ諢擾ｼ・ hint="蜈･蜉帙☆繧九→蜿ょ刈閠・↓騾・≡繝懊ち繝ｳ縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・>
                  <input ref={payUrlRef} style={S.input} type="url" inputMode="url"
                    autoCapitalize="none" autoCorrect="off" spellCheck={false}
                    placeholder="https://pay.paypay.ne.jp/..." defaultValue={ev.payUrl} />
                </Field>
                <div style={{ display: "flex", gap: 8, marginTop: 4 }}>
                  <button style={{ ...S.btn, ...S.btnGhost, flex: 1 }} onClick={() => setShowSetup(false)}>繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
                  <button style={{ ...S.btn, ...S.btnPrimary, flex: 1 }} onClick={startCollecting}>髮・≡繧帝幕蟋・/button>
                </div>
              </div>
            )}
          </div>

          <div style={{ display: "flex", gap: 10, marginBottom: 16 }}>
            <button onClick={() => setTab("rsvp")} style={{
              ...S.btn, ...S.btnSm,
              background: tab === "rsvp" ? C.primary : C.border,
              color: tab === "rsvp" ? "#fff" : C.text,
            }}>蜃ｺ谺 ({ev.members.length})</button>
            <button onClick={() => setTab("collect")} style={{
              ...S.btn, ...S.btnSm,
              background: tab === "collect" ? C.primary : C.border,
              color: tab === "collect" ? "#fff" : C.text,
            }}>髮・≡ ({yesMembers.length})</button>
          </div>

          {tab === "rsvp" && (
            <div>
              {yesMembers.length > 0 && (
                <div style={{ marginBottom: 20 }}>
                  <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.success, marginBottom: 8 }}>蜿ょ刈 ({yesMembers.length})</p>
                  {yesMembers.map((m) => <MemberRow key={m.id} m={m} onRemove={() => removeMember(m.id)} />)}
                </div>
              )}
              {maybeMembers.length > 0 && (
                <div style={{ marginBottom: 20 }}>
                  <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.warn, marginBottom: 8 }}>譛ｪ螳・({maybeMembers.length})</p>
                  {maybeMembers.map((m) => <MemberRow key={m.id} m={m} onRemove={() => removeMember(m.id)} />)}
                </div>
              )}
              {noMembers.length > 0 && (
                <div>
                  <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.danger, marginBottom: 8 }}>荳榊盾蜉 ({noMembers.length})</p>
                  {noMembers.map((m) => <MemberRow key={m.id} m={m} onRemove={() => removeMember(m.id)} />)}
                </div>
              )}
            </div>
          )}

          {tab === "collect" && (
            <div>
              {!ev.collecting && (
                <div style={{ marginBottom: 12, padding: "12px", background: C.neutralBg, borderRadius: C.radius }}>
                  <p style={{ fontSize: "0.78rem", color: C.textMuted }}>髮・≡繧帝幕蟋九☆繧九→繝√ぉ繝・け縺ｧ縺阪∪縺・/p>
                </div>
              )}
              {ev.collecting && (
                <>
                  <div style={{ marginBottom: 16, padding: "12px", background: C.neutralBg, borderRadius: C.radius, textAlign: "center" }}>
                    <p style={{ fontSize: "0.7rem", color: C.textMuted }}>髮・≡迥ｶ豕・/p>
                    <p style={{ fontSize: "1.2rem", fontWeight: 700, color: C.text, marginTop: 4 }}>{paidCount} / {yesMembers.length}</p>
                  </div>
                  {yesMembers.map((m) => (
                    <div key={m.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "10px 0", borderBottom: `1px solid ${C.border}` }}>
                      <span style={{ fontSize: "0.875rem", color: C.text }}>{m.name}</span>
                      <button onClick={() => togglePaid(m.id)} style={{
                        ...S.btn, ...S.btnSm,
                        background: m.paid ? C.success : C.border, color: m.paid ? "#fff" : C.text,
                      }}>{m.paid ? "貂・ : "譛ｪ"}</button>
                    </div>
                  ))}
                </>
              )}
            </div>
          )}
        </div>
      );
    }
    function ParticipantPage({ eventId }) {
      const [ev, setEv] = useState(null);
      const [step, setStep] = useState("rsvp");
      const [myName, setMyName] = useState("");
      const nameRef = useRef(null);
      const hydratedFromUrl = useRef(false);

      const getCurrentEvent = () => {
        const all = db.get("atsumeru_events") || [];
        return all.find((e) => e.id === eventId) || null;
      };

      const writeNameToUrl = (name) => {
        const u = new URL(window.location.href);
        u.searchParams.set("event", eventId);
        u.searchParams.set("name", name);
        window.history.replaceState({}, "", u.toString());
      };

      const load = () => setEv(getCurrentEvent());

      useEffect(() => {
        load();
        const onStorage = (e) => { if (e.key === "atsumeru_events") load(); };
        window.addEventListener("storage", onStorage);
        const timer = setInterval(load, 1000);
        return () => { window.removeEventListener("storage", onStorage); clearInterval(timer); };
      }, [eventId]);

      useEffect(() => {
        if (step !== "paying") return;
        const h = () => { if (document.visibilityState === "visible") setStep("confirm"); };
        const f = () => setStep("confirm");
        document.addEventListener("visibilitychange", h);
        window.addEventListener("focus", f);
        return () => { document.removeEventListener("visibilitychange", h); window.removeEventListener("focus", f); };
      }, [step]);

      useEffect(() => {
        if (hydratedFromUrl.current || !ev) return;
        const n = (new URLSearchParams(window.location.search).get("name") || "").trim();
        hydratedFromUrl.current = true;
        if (!n) return;
        const member = ev.members.find((m) => m.name === n);
        if (!member) return;
        setMyName(n);
        if (ev.collecting && member.rsvp === "yes") setStep("rsvp_done");
      }, [ev]);

      const submitRsvp = (rsvp) => {
        const name = nameRef.current?.value?.trim();
        if (!name) { alert("蜷榊燕繧貞・蜉帙＠縺ｦ縺上□縺輔＞"); return; }
        const all = db.get("atsumeru_events") || [];
        const updated = all.map((e) => {
          if (e.id !== eventId) return e;
          const existing = e.members.find((m) => m.name === name);
          if (existing) return { ...e, members: e.members.map((m) => m.name === name ? { ...m, rsvp } : m) };
          return { ...e, members: [...e.members, { id: genId(), name, rsvp, paid: false, paidAt: null }] };
        });
        db.set("atsumeru_events", updated);
        const nextEv = updated.find((e) => e.id === eventId) || null;
        if (!nextEv) { alert("繧､繝吶Φ繝医′隕九▽縺九ｊ縺ｾ縺帙ｓ"); return; }
        setEv(nextEv);
        writeNameToUrl(name);
        if (rsvp === "yes" && nextEv.collecting) { startPaymentFlow(name); return; }
        setMyName(name);
        setStep("rsvp_done");
      };

      const startPaymentFlow = (name) => {
        const current = getCurrentEvent();
        if (!current) return;
        const member = current.members.find((m) => m.name === name);
        if (!member || member.rsvp !== "yes") { alert("蜿ょ刈諠・ｱ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ"); return; }
        if (member.paid) { setMyName(name); setEv(current); setStep("rsvp_done"); return; }
        writeNameToUrl(name);
        setMyName(name);
        setEv(current);
        if (current.payUrl) {
          setStep("paying");
          setTimeout(() => { window.open(current.payUrl, "_blank"); }, 100);
        } else {
          setStep("confirm");
        }
      };

      const openPayLink = () => {
        if (!myName) return;
        startPaymentFlow(myName);
      };

      const confirmPaid = () => {
        const all = db.get("atsumeru_events") || [];
        const updated = all.map((e) => {
          if (e.id !== eventId) return e;
          return { ...e, members: e.members.map((m) =>
            m.name === myName ? { ...m, paid: true, paidAt: new Date().toISOString() } : m
          )};
        });
        db.set("atsumeru_events", updated);
        setStep("done");
      };

      const handlePayLaterBySelection = (name) => {
        if (!name) return;
        const member = (ev?.members || []).find((m) => m.name === name);
        if (!member || member.rsvp !== "yes" || member.paid) return;
        writeNameToUrl(name);
        startPaymentFlow(name);
      };

      const Header = () => (
        <div style={{ borderBottom: `1px solid ${C.border}`, background: C.surface, marginBottom: 24 }}>
          <div style={{ ...S.wrap, height: 52, display: "flex", alignItems: "center" }}>
            <span style={{ fontSize: "0.9rem", fontWeight: 700, color: C.primary }}>繧｢繝・Γ繝ｫ</span>
          </div>
        </div>
      );

      if (!ev) return (
        <>
          <Header />
          <div style={{ ...S.wrap, textAlign: "center", paddingTop: 48 }}>
            <div style={S.cardLg}>
              <p style={{ color: C.textSub }}>繧､繝吶Φ繝医′隕九▽縺九ｊ縺ｾ縺帙ｓ</p>
            </div>
          </div>
        </>
      );

      if (step === "done") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingTop: 24, ...S.anim }}>
            <div style={{ ...S.cardLg, textAlign: "center", padding: "44px 24px", borderColor: C.success }}>
              <div style={{ fontSize: "0.75rem", fontWeight: 700, color: C.success, letterSpacing: "0.06em", marginBottom: 12 }}>螳御ｺ・/div>
              <h2 style={{ ...S.h2, marginBottom: 8 }}>謾ｯ謇輔＞繧貞ｱ蜻翫＠縺ｾ縺励◆</h2>
              <p style={S.sub}>蟷ｹ莠九↓蜿肴丐縺輔ｌ縺ｾ縺励◆縲ゅ≠繧翫′縺ｨ縺・＃縺悶＞縺ｾ縺吶・/p>
            </div>
          </div>
        </>
      );

      if (step === "confirm") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingTop: 24, ...S.anim }}>
            <div style={{ ...S.cardLg, textAlign: "center" }}>
              <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.textMuted, letterSpacing: "0.06em", marginBottom: 12 }}>遒ｺ隱・/p>
              <h2 style={{ ...S.h2, marginBottom: 8 }}>騾・≡縺ｯ螳御ｺ・＠縺ｾ縺励◆縺具ｼ・/h2>
              <p style={{ ...S.sub, marginBottom: 28 }}>{myName}縺輔ｓ縺ｮ謾ｯ謇輔＞繧定ｨ倬鹸縺励∪縺・/p>
              <button style={{ ...S.btn, ...S.btnSuccess, marginBottom: 10 }} onClick={confirmPaid}>縺ｯ縺・・・≡縺励∪縺励◆</button>
              <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => setStep("rsvp_done")}>縺ｾ縺縺励※縺・↑縺・/button>
            </div>
          </div>
        </>
      );

      if (step === "paying") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingTop: 24, textAlign: "center", ...S.anim }}>
            <div style={S.cardLg}>
              <div style={{ width: 36, height: 36, borderRadius: "50%", border: `2px solid ${C.border}`, borderTopColor: C.primary, animation: "spin 0.9s linear infinite", margin: "0 auto 20px" }} />
              <h2 style={{ ...S.h2, marginBottom: 8 }}>騾・≡繧｢繝励Μ繧帝幕縺・※縺・∪縺・/h2>
              <p style={{ ...S.sub, marginBottom: 24 }}>騾・≡縺檎ｵゅｏ縺｣縺溘ｉ縺薙・繝壹・繧ｸ縺ｫ謌ｻ縺｣縺ｦ縺上□縺輔＞</p>
              <button style={{ ...S.btn, ...S.btnGhost }} onClick={() => setStep("confirm")}>騾・≡縺檎ｵゅｏ縺｣縺・/button>
            </div>
          </div>
        </>
      );

      const yesMembers = ev.members.filter((m) => m.rsvp === "yes");
      const myMember = myName ? ev.members.find((m) => m.name === myName) : null;

      if (step === "rsvp_done") return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingBottom: 60, ...S.anim }}>
            <div style={S.cardLg}>
              <div style={{ textAlign: "center", marginBottom: 20 }}>
                <div style={{ display: "inline-flex", alignItems: "center", justifyContent: "center", width: 40, height: 40, borderRadius: "50%", background: C.successBg, color: C.success, fontSize: "1rem", marginBottom: 12 }}>笨・/div>
                <h2 style={{ ...S.h2, marginBottom: 4 }}>蝗樒ｭ斐＠縺ｾ縺励◆</h2>
                <p style={{ fontSize: "0.8rem", color: C.textMuted }}>{myName}縺輔ｓ ・・{myMember?.rsvp === "yes" ? "蜿ょ刈" : myMember?.rsvp === "no" ? "荳榊盾蜉" : "譛ｪ螳・}</p>
              </div>

              {ev.collecting && myMember?.rsvp === "yes" && !myMember?.paid && (
                <div style={{ background: C.bg, borderRadius: C.radius, padding: 18, marginBottom: 4 }}>
                  <div style={{ textAlign: "center", marginBottom: 14 }}>
                    <div style={{ fontSize: "1.5rem", fontWeight: 700, color: C.text, letterSpacing: "-0.02em" }}>ﾂ･{ev.amount.toLocaleString()}</div>
                    <p style={{ fontSize: "0.72rem", color: C.textMuted, marginTop: 2 }}>縺頑髪謇輔＞驥鷹｡・/p>
                  </div>
                  {ev.payUrl
                    ? <button style={{ ...S.btn, background: "#E00020", color: "#fff" }} onClick={openPayLink}>PayPay縺ｧ騾・≡縺吶ｋ</button>
                    : <button style={{ ...S.btn, ...S.btnPrimary }} onClick={() => setStep("confirm")}>騾・≡縺励◆縺ｮ縺ｧ蝣ｱ蜻翫☆繧・/button>
                  }
                </div>
              )}

              {ev.collecting && myMember?.paid && (
                <div style={{ background: C.successBg, borderRadius: C.radius, padding: 16, textAlign: "center", marginBottom: 4 }}>
                  <span style={{ fontSize: "0.875rem", fontWeight: 600, color: C.success }}>謾ｯ謇輔＞貂医∩縺ｧ縺・/span>
                </div>
              )}

              {yesMembers.length > 0 && (
                <div style={{ marginTop: 20, borderTop: `1px solid ${C.border}`, paddingTop: 16 }}>
                  <p style={{ fontSize: "0.72rem", fontWeight: 700, color: C.textMuted, marginBottom: 8, letterSpacing: "0.03em" }}>蜿ょ刈閠・{yesMembers.length}蜷・/p>
                  {yesMembers.map((m) => (
                    <div key={m.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "6px 0" }}>
                      <span style={{ fontSize: "0.85rem", color: C.text }}>{m.name}</span>
                      {ev.collecting && (
                        <span style={S.badge(m.paid ? C.successBg : C.warnBg, m.paid ? C.success : C.warn)}>
                          {m.paid ? "貂・ : "譛ｪ"}
                        </span>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </>
      );

      return (
        <>
          <Header />
          <div style={{ ...S.wrap, paddingBottom: 60, ...S.anim }}>
            <div style={S.cardLg}>
              <h2 style={{ ...S.h2, marginBottom: 4 }}>{ev.title}</h2>
              <p style={{ fontSize: "0.78rem", color: C.textMuted, marginBottom: 2 }}>{ev.date ? fmtDate(ev.date) : "譌･譎よ悴螳・}{ev.place ? `縲${ev.place}` : ""}</p>
              {ev.note && <p style={{ fontSize: "0.78rem", color: C.textSub, marginTop: 4 }}>{ev.note}</p>}

              <div style={S.divider} />

              {/* 蜃ｺ谺繧貞屓遲斐☆繧・*/}
              <p style={{ fontWeight: 600, fontSize: "0.875rem", marginBottom: 14, color: C.text }}>蜃ｺ谺繧貞屓遲斐☆繧・/p>
              <Field label="蜷榊燕">
                <input ref={nameRef} style={S.input} type="text" placeholder="縺雁錐蜑・ defaultValue="" />
              </Field>
              <div className="rsvp-actions">
                <button style={{ ...S.btn, ...S.btnSuccess, flex: 1 }} onClick={() => submitRsvp("yes")}>蜿ょ刈</button>
                <button style={{ ...S.btn, ...S.btnWarn,   flex: 1 }} onClick={() => submitRsvp("maybe")}>譛ｪ螳・/button>
                <button style={{ ...S.btn, ...S.btnDanger, flex: 1 }} onClick={() => submitRsvp("no")}>荳榊盾蜉</button>
              </div>

              {/* 縺ゅ→縺九ｉ謾ｯ謇輔≧ */}
              {ev.collecting && (() => {
                const unpaid = ev.members.filter((m) => m.rsvp === "yes" && !m.paid);
                if (unpaid.length === 0) return null;
                return (
                  <div style={{ marginTop: 20, padding: "16px", background: C.bg, borderRadius: C.radius, border: `1px solid ${C.border}` }}>
                    <p style={{ fontSize: "0.75rem", fontWeight: 700, color: C.textSub, marginBottom: 2 }}>縺ゅ→縺九ｉ謾ｯ謇輔≧</p>
                    <p style={{ fontSize: "0.72rem", color: C.textMuted, marginBottom: 12 }}>閾ｪ蛻・・蜷榊燕繧帝∈繧薙〒縺上□縺輔＞</p>
                    <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                      {unpaid.map((m) => (
                        <button key={m.id} onClick={() => handlePayLaterBySelection(m.name)} style={{
                          display: "flex", alignItems: "center", gap: 10,
                          padding: "10px 12px", borderRadius: C.radiusSm,
                          border: `1.5px solid ${C.border}`,
                          background: C.surface,
                          cursor: "pointer", fontFamily: C.font, width: "100%", textAlign: "left",
                          transition: "all 0.12s",
                        }}>
                          <div style={{ width: 18, height: 18, borderRadius: "50%", flexShrink: 0, border: `2px solid ${C.borderDark}`, background: "transparent", display: "flex", alignItems: "center", justifyContent: "center", transition: "all 0.12s" }}>
                            <div style={{ width: 6, height: 6, borderRadius: "50%", background: C.borderDark }} />
                          </div>
                          <span style={{ fontSize: "0.875rem", color: C.text, fontWeight: 500 }}>{m.name}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                );
              })()}

              {ev.members.length > 0 && (
                <div style={{ marginTop: 24, borderTop: `1px solid ${C.border}`, paddingTop: 16 }}>
                  <p style={{ fontSize: "0.72rem", fontWeight: 700, color: C.textMuted, marginBottom: 8, letterSpacing: "0.03em" }}>蝗樒ｭ皮憾豕√{ev.members.length}蜷・/p>
                  {ev.members.map((m) => (
                    <div key={m.id} style={{ display: "flex", alignItems: "center", justifyContent: "space-between", padding: "6px 0" }}>
                      <span style={{ fontSize: "0.85rem", color: C.text }}>{m.name}</span>
                      <span style={S.badge(
                        m.rsvp === "yes" ? C.successBg : m.rsvp === "no" ? C.dangerBg : C.warnBg,
                        m.rsvp === "yes" ? C.success : m.rsvp === "no" ? C.danger : C.warn,
                      )}>{m.rsvp === "yes" ? "蜿ょ刈" : m.rsvp === "no" ? "荳榊盾蜉" : "譛ｪ螳・}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </>
      );
    }
    function App() {
      const [page, setPage]     = useState("home");
      const [pageArg, setPageArg] = useState(null);
      const [user, setUser]     = useState(null);

      const go = (p, arg) => { setPage(p); setPageArg(arg || null); };

      useEffect(() => {
        const saved = db.get("atsumeru_user");
        if (saved) setUser(saved);
        const params = new URLSearchParams(window.location.search);
        const eid = params.get("event");
        if (eid) { setPage("participant"); setPageArg(eid); }
      }, []);

      const logout = () => { setUser(null); db.set("atsumeru_user", null); go("home"); };

      return (
        <div style={{ fontFamily: C.font, background: C.bg, color: C.text,
          minHeight: "100vh", lineHeight: 1.6, WebkitFontSmoothing: "antialiased" }}>
          {page !== "participant" && <Nav goHome={() => go("home")} user={user} logout={logout} />}
          {page === "participant" && <ParticipantPage eventId={pageArg} />}
          {page === "home"        && <Home go={go} user={user} />}
          {page === "login"       && <Login go={go} setUser={setUser} />}
          {page === "create"      && <Create go={go} user={user} />}
          {page === "list"        && <EventList go={go} user={user} />}
          {page === "manage"      && <Manage eventId={pageArg} go={go} />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>

